/**
 * Navimi v0.4.0 
 * Developed by Ivan Valadares 
 * ivanvaladares@hotmail.com 
 * https://github.com/ivanvaladares/navimi 
 */ 
class __Navimi_Components{constructor(){this._components={},this._uidCounter=0,this._removeComponent=t=>{t.localName&&!t.__removed&&this._components[t.localName]&&(t.__removed=!0,this._removeChildComponents(t),this._disconnectComponent(t),t.remove(),t.___onUnmount&&t.___onUnmount())},this._disconnectComponent=e=>{e.parentComponent&&(e.parentComponent.childComponents=e.parentComponent.childComponents.filter(t=>t!==e))},this._removeChildComponents=t=>{t.childComponents&&t.childComponents.map(t=>{this._removeComponent(t)})},this._readAttributes=s=>{var t=s.props;return s.props={},[].slice.call(s.attributes).map(t=>{var e=t.name;"function"!=typeof s[e]&&(s.props=Object.assign(Object.assign({},s.props||{}),{[e]:t.value}))}),t},this._traverseComponentsTree=(t,e)=>{t.localName&&(this._components[t.localName]?e(t):[].slice.call(t.childNodes).map(t=>{this._traverseComponentsTree(t,e)}))},this._registerTag=(t,e)=>{if(!t.props&&this._components[t.localName]){const s=this._components[t.localName],i=(t.props={},t.parentComponent=void 0,t.childComponents=[],this._findParentComponent(t,e),this._readAttributes(t),new s(t));i.init()}},this._findParentComponent=(e,t)=>{var s=t=>{(e.parentComponent=t).childComponents=[...t.childComponents||[],e]};if(t)s(t);else{let t=e.parentNode;for(;t;){if(/-/.test(t.localName)&&this._components[t.localName])return void s(t);t=t.parentNode}}},this._bindChildEvents=(e,s)=>{s.attributes&&[].slice.call(s.attributes).map(t=>{t=t.name;"function"==typeof s[t]&&(s[t]=s[t].bind(e))})},this._registerChildNodes=e=>{const s=t=>{[].slice.call(t.childNodes).map(t=>{this._components[t.localName]||(this._bindChildEvents(e,t),s(t))})};s(e)},this._mergeHtml=(t,s)=>{var i=t=>3===t.nodeType?"text":8===t.nodeType?"comment":t.tagName.toLowerCase(),n=t=>t.childNodes&&0<t.childNodes.length?null:t.textContent,a=[].slice.call(t.childNodes);let r=[].slice.call(s.childNodes),o=r.length-a.length;for(let e=0;e<a.length;e++){const c=a[e];if(r[e])if(i(c)!==i(r[e]))0<o?(this._traverseComponentsTree(r[e],this._removeComponent),r[e].parentNode&&r[e].parentNode.removeChild(r[e]),e--):s.insertBefore(c.cloneNode(!0),r[e]),r=[].slice.call(s.childNodes);else{var h=n(c);if(h&&h!==n(r[e])&&(r[e].textContent=h),c.localName){if(c.localName===r[e].localName){const _=[].slice.call(r[e].attributes),m=[].slice.call(c.attributes);var h=m.filter(e=>_.find(t=>e.name===t.name&&e.value!==t.value));const d=_.filter(e=>!m.find(t=>e.name===t.name));var l=m.filter(e=>!_.find(t=>e.name===t.name));d.map(t=>{r[e].removeAttribute(t.name)}),[...h,...l].map(t=>{r[e].setAttribute(t.name,t.value)})}this._components[c.localName]||(0<r[e].childNodes.length&&c.childNodes.length<1?r[e].innerHTML="":r[e].childNodes.length<1&&0<c.childNodes.length?(h=document.createDocumentFragment(),this._mergeHtml(c,h),r[e].appendChild(h)):0<c.childNodes.length&&this._mergeHtml(c,r[e]))}}else s.appendChild(c.cloneNode(!0))}for(o=r.length-a.length;0<o;){var e=r.length-o;this._traverseComponentsTree(r[e],this._removeComponent),r[e].parentNode&&r[e].parentNode.removeChild(r[e]),o--}this._registerChildNodes(s)},this.registerComponent=(t,e,s,i)=>{if(t&&/-/.test(t)){s=s||(()=>{});const a=this;Object.setPrototypeOf(e.prototype,HTMLElement.prototype);var n=class{constructor(t){this.init=async()=>{await this.render(),this._component.onMount&&await this._component.onMount.call(this._node)},this.render=async()=>{var t=this._component.render&&await this._component.render.call(this._node,this._initalInnerHTML);if(t&&t!==this._previousTemplate){this._previousTemplate=t;const e=(new DOMParser).parseFromString(t,"text/html");a._mergeHtml(e.querySelector("body"),this._node)}this._component.onRender&&this._component.onRender.call(this._node)},this._uid="component:"+a._uidCounter++,this._node=t,this._previousTemplate=void 0,this._initalInnerHTML=t.innerHTML,t.innerHTML="",this._component=new e(this._node.props,s(this._uid),i),Object.setPrototypeOf(this._node,this._component),this._component.update=a._navimiHelpers.throttle(this.render,16,this._node),this._component.___onUnmount=()=>{a._navimiState.unwatchState(this._uid),this._component.onUnmount&&this._component.onUnmount.call(this._node)}}};return this._components[t]=n}}}init(t,e){this._navimiHelpers=t,this._navimiState=e,new window.MutationObserver(t=>{t.forEach(t=>{if("attributes"===t.type){const s=t.target;var e;this._components[s.localName]&&(e=this._readAttributes(s),s.shouldUpdate&&!s.shouldUpdate(e,s.props)||s.update())}else[].slice.call(t.addedNodes).map(t=>{this._traverseComponentsTree(t,this._registerTag)}),[].slice.call(t.removedNodes).map(t=>{this._traverseComponentsTree(t,this._removeComponent)})})}).observe(document,{childList:!0,subtree:!0,attributes:!0})}}class __Navimi_Core{constructor(t,e,s){this._navigateTo=(t,e)=>{this._initRoute(t,e)},this._reportError=t=>{this._options.onError?this._options.onError(t):console.error(t)},this._waitForAssets=i=>{const n=this._options.globalCssUrl,a=this._options.globalTemplatesUrl;return n||a?new Promise(e=>{const s=setInterval(()=>{let t=!0;if((n&&!this._navimiCSSs.isCssLoaded(n)||a&&!this._navimiTemplates.isTemplateLoaded(a))&&(t=!1),this._navimiFetch.getErrors(n)||this._navimiFetch.getErrors(a)||t||i<this._callId)return clearInterval(s),e()},10)}):Promise.resolve()},this._initRoute=async(t,e,s)=>{try{var i=this._navimiHelpers.removeHash(t||this._navimiHelpers.getUrl());if(!s){if(this._currentUrl===i)return;this._abortController&&this._abortController.abort(),this._abortController=window.AbortController?new AbortController:void 0}var n=++this._callId,a=void 0!==t,{routeItem:r,params:o}=this._navimiHelpers.getRouteAndParams(i,this._routesList),h=Object.assign({url:i,routeItem:r,params:o},e||{});if(!s){if(this._options.onBeforeRoute)if(!1===await this._options.onBeforeRoute(h,this._navigateTo))return;if(this._currentJSUrl){const v=this._navimiJSs.getInstance(this._currentJSUrl);if(v){const g=v.onBeforeLeave;if(g)if(!1===g(h))return void(a||history.forward());v.onLeave&&v.onLeave()}}}if(!r)return void(n===this._callId&&this._reportError(new Error("No route match for url: "+i)));if(await this._navimiMiddlewares.executeMiddlewares(this._abortController,h,(t,e)=>{this._initRoute(t,e,!0)}).catch(this._reportError),n<this._callId)return;this._currentUrl=i;var{title:l,jsUrl:c,cssUrl:_,templatesUrl:m,services:d,components:p}=r||{};if(!c&&!m)throw new Error("The route must define the 'jsUrl' or 'templatesUrl'!");if(c&&(this._currentJSUrl=c,this._routesParams[c]=h),a&&(e&&e.replaceUrl?history.replaceState(null,null,t):history.pushState(null,null,t)),await Promise.all([this._navimiJSs.loadServices(this._abortController,c||i,d),this._navimiJSs.loadComponents(this._abortController,c||i,p),this._navimiCSSs.fetchCss(this._abortController,_),this._navimiTemplates.fetchTemplate(this._abortController,m),c&&this._navimiJSs.fetchJS(this._abortController,[c],"route")]).catch(this._reportError),await this._waitForAssets(n),this._navimiHelpers.setTitle(l),this._globalCssInserted||(this._globalCssInserted=!0,this._navimiCSSs.insertCss(this._options.globalCssUrl,"globalCss")),c)await this._navimiJSs.initRoute(c,this._routesParams[c]);else{var u=this._navimiTemplates.getTemplate(m);const f=document.querySelector("body");u&&f&&(f.innerHTML=u)}n===this._callId&&(this._navimiHelpers.setNavimiLinks(),this._navimiCSSs.insertCss(_,"routeCss"),this._options.onAfterRoute&&this._options.onAfterRoute(h,this._navigateTo))}catch(t){this._reportError(t)}},this._callId=0,this._abortController=window.AbortController?new AbortController:void 0,this._currentJSUrl,this._currentUrl,this._routesParams={},this._routesList=t||{},this._options=s||{},this._globalCssInserted=!1,this._win=window||{},this._navimiFetch=e.navimiFetch,this._navimiCSSs=e.navimiCSSs,this._navimiJSs=e.navimiJSs,this._navimiTemplates=e.navimiTemplates,this._navimiMiddlewares=e.navimiMiddlewares,this._navimiHot=e.navimiHot,this._navimiHelpers=e.navimiHelpers,this._win.addEventListener("popstate",()=>{this._initRoute()}),this._win.navigateTo=this._navigateTo,this._navimiMiddlewares.addMiddlewares(this._options.middlewares),(async()=>{await this._init()})(),this._initRoute(),this._options.hot&&this._initHot()}_init(){if(this._options.globalCssUrl||this._options.globalTemplatesUrl)return Promise.all([this._navimiCSSs.fetchCss(void 0,this._options.globalCssUrl),this._navimiTemplates.fetchTemplate(void 0,this._options.globalTemplatesUrl)]).catch(this._reportError)}_initHot(){}}class __Navimi_CSSs{constructor(){this._loadedCsss={},this._cssRulesCache={},this._cssCount=0,this._atomicCssId="__navimi__cssInJs__",this._replaceCss=(t,e)=>{const s=document.querySelector(`[cssUrl='${e}']`);s&&(s.innerHTML=t)},this._insertCssRule=({className:t,child:e,media:s,cssRule:i})=>{this._cssSheet||(n=document.querySelector(`style[id=${this._atomicCssId}]`),this._cssSheet=n.sheet);var n=`.${""+t+e}{${i.join(";")}}`;this._cssSheet.insertRule(s?s+`{${n}}`:n,this._cssSheet.cssRules.length)},this._addCssToDom=(t,e,s)=>{if(!document)return null;const i=document.createElement("style");i.innerHTML=t,s&&Object.entries(s).forEach(([t,e])=>{i.setAttribute(t,e)});const n=document.getElementsByTagName("head")[0]||document.body;e?n.insertBefore(i,n.firstChild):n.appendChild(i)},this._parseCssRules=(t,a="",r="")=>Object.entries(t).reduce((t,[e,s])=>{var i,n;return s&&"object"==typeof s?(n=(i=/^@/.test(e)?e:null)?a:a+e.replace(/&/g,""),t.concat(this._parseCssRules(s,n,i||r))):t.concat({media:r,child:a,cssRule:[e+":"+s]})},[]),this.isCssLoaded=t=>void 0!==this._loadedCsss[t],this.fetchCss=(t,e)=>!e||this._loadedCsss[e]?Promise.resolve():this._navimiFetch.fetchFile(e,{headers:{Accept:"text/css"},signal:t?t.signal:void 0}).then(t=>{this._loadedCsss[e]=t}),this.insertCss=(t,e,s)=>{if("routeCss"===e){const n=document.querySelector(`[cssType='${e}']`);if(n){if(n.getAttribute("cssUrl")===t)return;n.remove()}}var i;document.querySelector(`[cssUrl='${t}']`)||(i=this._loadedCsss[t])&&this._addCssToDom(i,s,{cssUrl:t,cssType:e})},this.style=(...t)=>t.map(t=>this._parseCssRules(t).map(t=>{var e=JSON.stringify(t);if(this._cssRulesCache[e])return this._cssRulesCache[e];var s="__navimi_"+this._cssCount++;return this._insertCssRule(Object.assign(Object.assign({},t),{className:s})),this._cssRulesCache[e]=s}).join(" ")).join("")}init(t){this._navimiFetch=t,this._addCssToDom("",!0,{id:this._atomicCssId})}}class __Navimi_Fetch{constructor(){this.loadErrors={},this.init=t=>{this._bustCache=t.bustCache},this.getErrors=t=>this.loadErrors[t],this.fetchFile=(n,a)=>new Promise((e,s)=>{delete this.loadErrors[n];var t=n+(this._bustCache?"?v="+this._bustCache:"");const i="Could not load the file! - "+n;fetch(t,a).then(t=>{if(!t||!t.ok)return this.loadErrors[n]=i,s(i);t.text().then(e)}).catch(()=>{this.loadErrors[n]=i,s(i)})})}}class __Navimi_Helpers{constructor(){this.parseQuery=t=>{const e={};return t.split("&").map(t=>{t=t.split("=");e[decodeURIComponent(t[0])]=decodeURIComponent(t[1]||"")}),e},this.splitPath=t=>{if(!t)return[];var e=t.indexOf("?");return(t=0<=e?t.substring(0,e):t).split("/").filter(t=>0<t.length)},this.parsePath=(t,e)=>{var s=t.indexOf("?"),i=0<s?t.substring(s+1,t.length):"";const n=this.splitPath(t),a=this.splitPath(e);let r={};0<s&&(r={queryString:this.parseQuery(i)});for(let t=0;t<a.length;t++)if(":"===a[t].charAt(0)){var o=a[t].slice(1);if(n.length<=t)return null;r[o]=decodeURIComponent(n[t])}else if(!n[t]||a[t].toLowerCase()!==n[t].toLowerCase())return null;return r},this.debounce=(e,s)=>{let i;return function(...t){clearTimeout(i),i=setTimeout(()=>{i=null,e.apply(this,t)},s)}},this.throttle=(s,i,n)=>{let a,r;return function(...t){const e=Date.now();r&&e<r+i?(clearTimeout(a),a=setTimeout(()=>{r=e,s.apply(n,t)},i)):(r=e,s.apply(n,t))}},this.getUrl=()=>{const t=document.location;var e=t.toString().match(/^[^#]*(#.+)$/);const s=e?e[1]:"";return[t.pathname,t.search,s].join("")},this.setTitle=t=>{document.title=t},this.setNavimiLinks=()=>{document.querySelectorAll("[navimi-link]").forEach(t=>{t.removeAttribute("navimi-link"),t.addEventListener("click",t=>{t.preventDefault(),window.navigateTo(t.target.pathname)})})},this.removeHash=t=>{var e=t.indexOf("#");return 0<e?t.substring(0,e):t},this.stringify=t=>{const e=[],i=s=>{if("function"==typeof s)return String(s);if(s instanceof Error)return s.message;if(null===s||"object"!=typeof s)return s;if(-1!==e.indexOf(s))return`[Circular: ${e.indexOf(s)}]`;if(e.push(s),Array.isArray(s))return t=s.map(i),e.pop(),t;var t=Object.keys(s).reduce((t,e)=>(t[e]=i(((t,e)=>{if(Object.prototype.hasOwnProperty.call(t,e))try{return t[e]}catch(t){return}return t[e]})(s,e)),t),{});return e.pop(),t};return JSON.stringify(i(t))},this.cloneObject=s=>null===s||"object"!=typeof s?s:Object.keys(s).reduce((t,e)=>(null!==s[e]&&"object"==typeof s[e]?t[e]=this.cloneObject(s[e]):t[e]=s[e],t),Array.isArray(s)?[]:{}),this.getRouteAndParams=(t,e)=>{var s=this.splitPath(t),i=e["*"];let n,a;for(const o in e){var r=this.splitPath(o);if(r.length===s.length&&(a=this.parsePath(t,o))){n=e[o];break}}return!n&&i&&(a=this.parsePath(t,t),n=i),{routeItem:n,params:a}}}}class __Navimi_Hot{constructor(){this.openHotWs=t=>{try{if(!("WebSocket"in window))return void console.error("Websocket is not supported by your browser!");console.warn("Connecting HOT...");var e=!0===t?8080:t;this._wsHotClient=null,this._wsHotClient=new WebSocket("ws://localhost:"+e),this._wsHotClient.addEventListener("message",async t=>{try{var e=JSON.parse(t.data||"");if(e.message)return void console.warn(e.message);e.filePath&&await this._digestHot(e)}catch(t){console.error("Could not parse HOT message:",t)}}),this._wsHotClient.onclose=()=>{console.warn("HOT Connection Closed!"),setTimeout(this.openHotWs,5e3,t)}}catch(t){console.error(t)}},this._digestHot=async t=>{var e;try{switch(t.filePath=t.filePath.replace(/\\/g,"/"),null==(e=t.filePath.split(".").pop())?void 0:e.toLocaleLowerCase()){case"css":await this._navimiCSSs.digestHot(t).catch(()=>{});break;case"html":case"htm":await this._navimiTemplates.digestHot(t).then(()=>this._initRouteFunc()).catch(()=>{});break;case"js":this._navimiJSs.digestHot(t).then(()=>this._initRouteFunc()).catch(()=>{});break;case"gif":case"jpg":case"jpeg":case"png":case"svg":this._initRouteFunc()}}catch(t){console.error("Could not digest HOT payload: ",t)}}}init(t,e,s,i){this._navimiCSSs=t,this._navimiJSs=e,this._navimiTemplates=s,this._initRouteFunc=i}}class __Navimi_JSs{constructor(){this._navimiLoaderNS="__navimiLoader",this._callBackNS="_jsLoaderCallback",this._promiseNS="_promise_",this._loadedJSs={},this._jsType={},this._jsInstances={},this._jsDepMap={},this._servicesList={},this._uidCounter=0,this._resolvePromise=(t,e)=>{this._navimiLoader[this._promiseNS+e](t)},this._rejectPromise=(t,e)=>{this._navimiLoader[this._promiseNS+e+"_reject"](t)},this._awaitJS=n=>new Promise((e,s)=>{const i=setInterval(()=>{if(this._jsInstances[n])return clearInterval(i),e(this._jsInstances[n]);var t=this._jsType[n];if(("library"===t||"module"===t)&&this.isJsLoaded(n))return clearInterval(i),e("");t=this._navimiFetch.getErrors(n);return t?(clearInterval(i),s(t)):void 0},10)}),this._addLibrary=async t=>{const e=Array.isArray(t)?t:[t];if(0<e.length){const s=e.map(t=>{if("string"!=typeof t)return t;{const e=t.split(".").pop();return{url:t,type:e.toLowerCase()}}});await Promise.all(s.map(t=>{var e=t.type.toLowerCase();return"css"===e?this._navimiCSSs.fetchCss(void 0,t.url).then(()=>this._navimiCSSs.insertCss(t.url,"library",!0)):this.fetchJS(void 0,[t.url],"module"===e?"module":"library")})).catch(t=>{throw new Error(t)})}},this._fetch=async(t,e,s)=>{let i="";i=this._loadedJSs[e]||await this._navimiFetch.fetchFile(e,{headers:{Accept:"application/javascript"},signal:t?t.signal:void 0}),this._jsType[e]=s,this._insertJS(e,i.replace(/^\s+|\s+$/g,""),s)},this._insertJS=(t,e,s)=>{var i="module"===s||"library"===s?e:`((loader, url, type) => { loader(url, type, (() => { return ${e}
})())})(${this._navimiLoaderNS}.${this._callBackNS}, "${t}", "${s}")`;this._loadedJSs[t]=e;const n=document.querySelector(`[jsUrl='${t}']`),a=(n&&n.remove(),document.createElement("script")),r=(a.type="module"===s?"module":"text/javascript",a.innerHTML=i,a.setAttribute("jsUrl",t),document.getElementsByTagName("head")[0]);(r||document.body).appendChild(a),"module"!==s&&"library"!==s||this._resolvePromise(!0,t)},this._getFunctions=(s,i)=>Object.freeze({addLibrary:this._addLibrary,setTitle:this._navimiHelpers.setTitle,navigateTo:window.navigateTo,getTemplate:this._navimiTemplates.getTemplate,fetchJS:t=>{const e=Array.isArray(t)?t:[t];return e.map(t=>{this._jsDepMap[t]=Object.assign(Object.assign({},this._jsDepMap[t]||{}),{[i]:!0})}),this.fetchJS(void 0,e,"javascript")},fetchTemplate:t=>this._navimiTemplates.fetchTemplate(void 0,t),style:this._navimiCSSs.style,setState:this._navimiState.setState,getState:this._navimiState.getState,setNavimiLinks:this._navimiHelpers.setNavimiLinks,unwatchState:t=>this._navimiState.unwatchState(s,t),watchState:(t,e)=>this._navimiState.watchState(s,t,e)}),this._getServices=async(t,e)=>{if(Array.isArray(e)){const i=e.filter(t=>"string"==typeof t);0<i.length&&this.loadServices(void 0,t,i)}const s=[];for(const n in this._jsDepMap)this._jsDepMap[n][t]&&s.push(n);await Promise.all(s.map(this._awaitJS));let i={};return null!=(e=this._servicesList[t])&&e.map(t=>{i=Object.assign(Object.assign({},i),{[t]:this._jsInstances[this._options.services[t]]})}),Object.freeze(i)},this._getClassAndServices=async(t,e)=>{let s=e;Array.isArray(e)&&(s=e.pop());t=await this._getServices(t,e);return{JsClass:s,services:t}},this._buildRoute=async(t,e)=>{const s=this,{JsClass:i,services:n}=await this._getClassAndServices(t,e),a="route:"+ ++this._uidCounter;return new class extends i{constructor(){super(s._getFunctions(a,t),n)}onEnter(t){super.onEnter&&super.onEnter(t)}onBeforeLeave(t){return!super.onBeforeLeave||super.onBeforeLeave(t)}onLeave(){super.onLeave&&super.onLeave()}destroy(){s._navimiState.unwatchState(a),super.destroy&&super.destroy()}}},this._buildComponentClass=async(e,t)=>{var s,i=Object.keys(this._options.components).find(t=>this._options.components[t]===e);if(i&&/-/.test(i))return{JsClass:t,services:s}=await this._getClassAndServices(e,t),this._navimiComponents.registerComponent(i,t,t=>this._getFunctions(t,e),s)},this._instantiateJS=async(e,t,s)=>{try{var i;return"route"===t||"component"===t?(i="route"===t?await this._buildRoute(e,s):await this._buildComponentClass(e,s),this._jsInstances[e]=i,this._resolvePromise(i,e)):(this._jsInstances[e]=s,this._resolvePromise(s,e))}catch(t){this._rejectPromise(t,e)}},this._isJsLoading=t=>void 0!==this._navimiLoader[this._promiseNS+t]&&!this._navimiFetch.getErrors(t),this._checkDepsUrls=(s,t,i)=>{const n=[];this._servicesList[s]||(this._servicesList[s]=[]);t=(t||[]).map(t=>{var e=this._options[i]&&this._options[i][t];return void 0===e?n.push(t):("services"===i&&-1===this._servicesList[s].indexOf(t)&&this._servicesList[s].push(t),this._jsDepMap[e]=Object.assign(Object.assign({},this._jsDepMap[e]||{}),{[s]:!0})),e});if(0<n.length)throw new Error(i+" not defined: "+n.join(", "));return t},this.isJsLoaded=t=>void 0!==this._loadedJSs[t],this.getInstance=t=>this._jsInstances[t],this.fetchJS=(i,t,n)=>{var e=s=>new Promise((t,e)=>this._jsInstances[s]?t(this._jsInstances[s]):!this._loadedJSs[s]||"module"!==n&&"library"!==n?this._isJsLoading(s)?this._awaitJS(s).then(t).catch(e):(this._navimiLoader[this._promiseNS+s]=t,this._navimiLoader[this._promiseNS+s+"_reject"]=e,void this._fetch(i,s,n).catch(e)):t(!0));return 1<t.length?Promise.all(t.map(e)):e(t[0])},this.loadServices=(e,t,s)=>{if(t){const i=this._checkDepsUrls(t,s,"services");t=i.filter(t=>void 0!==t).map(t=>this.fetchJS(e,[t],"service"));return Promise.all(t)}},this.loadComponents=(e,t,s)=>{if(t){const i=this._checkDepsUrls(t,s,"components");t=i.filter(t=>void 0!==t).map(t=>this.fetchJS(e,[t],"component"));return Promise.all(t)}},this.initRoute=async(t,e)=>{const s=this.getInstance(t);s&&s.onEnter&&await s.onEnter(e)}}init(t,e,s,i,n,a,r){this._navimiHelpers=t,this._navimiFetch=e,this._navimiCSSs=s,this._navimiTemplates=i,this._navimiState=n,this._navimiComponents=a,this._options=r,this._uidCounter=0,this._navimiLoader=window[this._navimiLoaderNS]={[this._callBackNS]:this._instantiateJS}}}class __Navimi_Middlewares{constructor(){this._middlewareStack=[],this.addMiddlewares=t=>{Array.isArray(t)&&this._middlewareStack.push(...t.filter(t=>void 0!==t))},this.executeMiddlewares=async(a,e,r)=>{let o;const h=async(s,i,n=0)=>{o=n;const t=this._middlewareStack[n];if(t)try{await t(e,async(t,e)=>{a&&a.signal.aborted?s():t?(r(t,e),s()):await h(s,i,n+1)})}catch(t){i(t)}else s()};return new Promise(h)}}}class Navimi{constructor(t,e,s,i){const n=null!=(h=null==s?void 0:s.navimiFetch)?h:new __Navimi_Fetch,a=null!=(h=null==s?void 0:s.navimiCSSs)?h:new __Navimi_CSSs,r=null!=(h=null==s?void 0:s.navimiJSs)?h:new __Navimi_JSs,o=null!=(h=null==s?void 0:s.navimiTemplates)?h:new __Navimi_Templates;var h=null!=(h=null==s?void 0:s.navimiMiddlewares)?h:new __Navimi_Middlewares;const l=null!=(c=null==s?void 0:s.navimiState)?c:new __Navimi_State;var c=null!=(c=null==s?void 0:s.navimiHot)?c:new __Navimi_Hot,_=null!=(_=null==s?void 0:s.navimiHelpers)?_:new __Navimi_Helpers;const m=null!=(s=null==s?void 0:s.navimiComponents)?s:new __Navimi_Components;m.init(_,l),n.init(e),a.init(n),r.init(_,n,a,o,l,m,e),o.init(n),l.init(_);s={navimiFetch:n,navimiJSs:r,navimiCSSs:a,navimiTemplates:o,navimiMiddlewares:h,navimiState:l,navimiHot:c,navimiHelpers:_,navimiComponents:m};return i?i(t,s,e):new __Navimi_Core(t,s,e)}}class __Navimi_State{constructor(){this._state={},this._stateWatchers={},this._prevState={},this._stateDiff={},this._getStateDiff=t=>{t.sort((t,e)=>e.length-t.length).map(e=>{this._stateDiff[e]||this._navimiHelpers.stringify(this.getState(e,this._prevState)||"")!==this._navimiHelpers.stringify(this.getState(e,this._state)||"")&&(this._stateDiff[e]=!0,t.map(t=>{e!==t&&0===e.indexOf(t)&&(this._stateDiff[t]=!0)}))})},this._mergeState=(t,e)=>{e instanceof Error&&(e=Object.assign(Object.assign({},e),{message:e.message,stack:e.stack}));var s=t=>t&&"object"==typeof t&&!Array.isArray(t)&&null!==t;if(s(t)&&s(e))for(const i in e)s(e[i])?(t[i]||Object.assign(t,{[i]:{}}),this._mergeState(t[i],e[i])):Object.assign(t,{[i]:e[i]})},this.setState=t=>{var e=Object.keys(this._stateWatchers);0<e.length&&(this._prevState=this._navimiHelpers.cloneObject(this._state)),this._mergeState(this._state,t),0<e.length&&(this._getStateDiff(e),this._invokeStateWatchers())},this.getState=(t,e)=>{t=t?t.split(".").reduce((t,e)=>t&&t[e]||void 0,e||this._state):e||this._state;return t?Object.freeze(this._navimiHelpers.cloneObject(t)):void 0},this.watchState=(t,e,s)=>{e&&s&&(this._stateWatchers[e]||(this._stateWatchers[e]={}),this._stateWatchers[e]=Object.assign(Object.assign({},this._stateWatchers[e]),{[t]:[...this._stateWatchers[e][t]||[],s]}))},this.unwatchState=(e,t)=>{const s=t=>{this._stateWatchers[t][e]=void 0,delete this._stateWatchers[t][e],0===Object.keys(this._stateWatchers[t]).length&&delete this._stateWatchers[t]};if(t){const i=Array.isArray(t)?t:[t];void i.map(t=>{this._stateWatchers[t]||(this._stateWatchers[t]={}),s(t)})}else Object.keys(this._stateWatchers).map(s)},this.clear=t=>{const e=Array.isArray(t)?t:[t||""];e.map(e=>{const s=e?e.split(".").reduce((t,e)=>t&&t[e]||void 0,this._state):this._state;s instanceof Object&&Object.keys(s).map(t=>{s[t]instanceof Object&&0<Object.keys(s[t]).length&&this.clear((e?e+".":"")+t),delete s[t]})})}}init(t){this._navimiHelpers=t,this._invokeStateWatchers=t.debounce(()=>{const t=Object.keys(this._stateWatchers),e=Object.keys(this._stateDiff);this._stateDiff={},t.filter(t=>0<=e.indexOf(t)).sort((t,e)=>e.length-t.length).map(s=>{Object.keys(this._stateWatchers[s]).map(t=>{const e=this.getState(s);this._stateWatchers[s][t]&&this._stateWatchers[s][t].map(t=>t&&t(e))})})},10)}}class __Navimi_Templates{constructor(){this._templatesCache={},this._loadedTemplates={},this.loadTemplate=(t,e)=>{let s=t;if(this._regIni.exec(s))for(;t&&0<t.length;){var i=this._regIni.exec(s);if(!i||0===i.length)break;const a=this._regId.exec(i[1]);var n=0<a.length&&a[1].slice(1,-1),i=(s=s.substring(i.index+i[0].length),this._regEnd.exec(s));if(!n||!i||0===i.length)break;this._templatesCache[n]=s.substring(0,i.index)}else this._templatesCache[e]=s},this.isTemplateLoaded=t=>void 0!==this._loadedTemplates[t],this.getTemplate=t=>{const e=Array.isArray(t)?t:[t];t=e.map(t=>this._templatesCache[t]);return 1<t.length?t:t[0]},this.fetchTemplate=(t,e)=>{var s=e=>!e||this._loadedTemplates[e]?Promise.resolve():this._navimiFetch.fetchFile(e,{headers:{Accept:"text/html"},signal:t?t.signal:void 0}).then(t=>{this.loadTemplate(t,e),this._loadedTemplates[e]=!0});const i=Array.isArray(e)?e:[e];return 1<i.length?Promise.all(i.map(s)):s(i[0])}}init(t){this._navimiFetch=t,this._regIni=new RegExp("<t ([^>]+)>"),this._regEnd=new RegExp("</t>"),this._regId=new RegExp("id=(\"[^\"]+\"|'[^']+')")}}