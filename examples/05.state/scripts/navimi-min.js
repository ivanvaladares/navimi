/**
 * Navimi v0.2.1 
 * Developed by Ivan Valadares 
 * ivanvaladares@hotmail.com 
 * https://github.com/ivanvaladares/navimi 
 */ 
class __Navimi_Core{constructor(t,e,i){this._navigateTo=(t,e)=>{this._initRoute(t,e)},this._reportError=t=>{this._options.onError?this._options.onError(t):console.error(t)},this._initRoute=async(t,e,c)=>{var i=__Navimi_Helpers.removeHash(t||__Navimi_Helpers.getUrl());if(!c){if(this._currentUrl===i)return;this._abortController.abort(),this._abortController=new AbortController}var s=++this._callId,_=void 0!==t;let{routeItem:a,params:r}=__Navimi_Helpers.getRouteAndParams(i,this._routesList);if((void 0!==e&&(r=Object.assign(Object.assign({},r),e)),this._options.onBeforeRoute)&&!1===await this._options.onBeforeRoute({url:i,routeItem:a,params:r},this._navigateTo))return;if(this._currentJS&&!c){const l=this._navimiJs.getInstance(this._currentJS);if(l){const p=l.beforeLeave;if(p)if(!1===p({url:i,routeItem:a,params:r}))return void(_||history.forward());l.destroy&&l.destroy()}}if(a){if(await this._navimiMiddleware.executeMiddlewares(this._abortController,{url:i,routeItem:a,params:r},(t,e)=>{this._initRoute(t,e,!0)}),!(s<this._callId)){this._currentUrl=i;try{var{title:m,jsUrl:n,cssUrl:o,templatesUrl:h,dependsOn:d}=a||{};if(!n&&!h)throw new Error("The route must define the 'jsUrl' or 'templatesUrl'!");n&&(this._currentJS=n,this._routesParams[n]={url:i,routeItem:a,params:r}),_&&(null!=e&&e.replaceUrl?history.replaceState(null,null,t):history.pushState(null,null,t)),this._navimiCss.fetchCss(this._abortController,o).catch(t=>{}),this._navimiTemplates.fetchTemplate(this._abortController,[h]).catch(t=>{});try{this._navimiJs.loadServices(this._abortController,n,d)}catch(t){this._reportError(t)}for(n&&await this._navimiJs.fetchJS(this._abortController,[n],!1);o&&!this._navimiCss.isCssLoaded(o)||h&&!this._navimiTemplates.isTemplateLoaded(h)||this._options.globalCssUrl&&!this._navimiCss.isCssLoaded(this._options.globalCssUrl)||this._options.globalTemplatesUrl&&!this._navimiTemplates.isTemplateLoaded(this._options.globalTemplatesUrl);){if(await __Navimi_Helpers.timeout(10),s<this._callId)return;if(o&&this._navimiFetch.getErrors(o)||h&&this._navimiFetch.getErrors(h)||this._options.globalCssUrl&&this._navimiFetch.getErrors(this._options.globalCssUrl)||this._options.globalTemplatesUrl&&this._navimiFetch.getErrors(this._options.globalTemplatesUrl))return void this._reportError(new Error(this._navimiFetch.getErrors(o)||this._navimiFetch.getErrors(h)||this._navimiFetch.getErrors(this._options.globalCssUrl)||this._navimiFetch.getErrors(this._options.globalTemplatesUrl)))}this._navimiDom.setTitle(m);try{if(!n){var v=this._navimiTemplates.getTemplate(h);const u=document.querySelector("body");return void(v&&u&&(u.innerHTML=v))}await this._navimiJs.initJS(n,this._routesParams[n])}catch(t){this._reportError(t)}finally{if(s<this._callId)return;this._navimiDom.setNavimiLinks(),this._navimiDom.insertCss(this._navimiCss.getCss(o),"routeCss"),this._options.onAfterRoute&&this._options.onAfterRoute({url:i,routeItem:a,params:r},this._navigateTo)}}catch(t){this._reportError(t)}}}else s===this._callId&&this._reportError(new Error("No route match for url: "+i))},this._callId=0,this._abortController=new AbortController,this._currentJS=void 0,this._currentUrl=void 0,this._routesParams={},this._routesList=t||{},this._options=e||{},this._win=window||{},this._navimiFetch=i.navimiFetch,this._navimiDom=i.navimiDom,this._navimiCss=i.navimiCss,this._navimiJs=i.navimiJs,this._navimiTemplates=i.navimiTemplates,this._navimiMiddleware=i.navimiMiddleware,this._navimiHot=i.navimiHot,this._win.addEventListener("popstate",()=>{this._initRoute()}),this._win.navigateTo=this._navigateTo,this._navimiMiddleware.addMiddlewares(this._options.middlewares),(async()=>{await this._init()})(),this._initRoute(),this._options.hot&&this._initHot()}async _init(){(this._options.globalCssUrl||this._options.globalTemplatesUrl)&&(await Promise.all([this._navimiCss.fetchCss(void 0,this._options.globalCssUrl),this._navimiTemplates.fetchTemplate(void 0,[this._options.globalTemplatesUrl])]).catch(this._reportError),this._navimiDom.insertCss(this._navimiCss.getCss(this._options.globalCssUrl),"globalCss"))}_initHot(){console.warn("HOT is disabled! Use the unminified version to enable it.")}}class __Navimi_CSSs{constructor(){this._loadedCsss={},this.isCssLoaded=t=>void 0!==this._loadedCsss[t],this.getCss=t=>this._loadedCsss[t],this.fetchCss=(s,a,r)=>new Promise(async(t,e)=>{if(!a||this._loadedCsss[a])return t();try{var i=await this._navimiFetch.fetchFile(a,{headers:{Accept:"text/css"},signal:s?s.signal:void 0});r?(this._navimiDom.insertCss(i,a,!0),this._loadedCsss[a]="loaded"):this._loadedCsss[a]=i,t()}catch(t){e(t)}}),this.reloadCss=(t,e,i,s,a)=>{const r=__Navimi_Helpers.isSameFile;if(r(a,t))return console.log(t+" updated."),this._loadedCsss[a]=e,void this._navimiDom.insertCss(e,"globalCss");for(const h in i){var{jsUrl:n,cssUrl:o}=i[h];if(r(o,t))return console.log(t+" updated."),this._loadedCsss[o]=e,void(s===n&&this._navimiDom.insertCss(e,"routeCss"))}}}init(t,e){this._navimiDom=t,this._navimiFetch=e}}const __NAVIMI_DEV=!0,__NAVIMI_PROD=!1;class __Navimi_Dom{constructor(){this.setTitle=t=>{document.title=t},this.setNavimiLinks=()=>{document.querySelectorAll("[navimi-link]").forEach(t=>{t.removeAttribute("navimi-link"),t.setAttribute("navimi-linked",""),t.addEventListener("click",t=>{t.preventDefault(),window.navigateTo(t.target.pathname)})})},this.insertCss=(t,e,i)=>{const s=e?document.querySelector(`[cssId='${e}']`):void 0;if(s&&s.remove(),t){const a=document.createElement("style");a.innerHTML=t,e&&a.setAttribute("cssId",e);const r=document.getElementsByTagName("head")[0]||document.body;i?r.prepend(a):r.appendChild(a)}},this.insertJS=(t,e)=>{const i=document.querySelector(`[jsUrl='${e}']`),s=(i&&i.remove(),document.createElement("script")),a=(s.type="text/javascript",s.innerHTML=t,s.setAttribute("jsUrl",e),document.getElementsByTagName("head")[0]);(a||document.body).appendChild(s)},this.addLibrary=async t=>{let e=Array.isArray(t)?t:[t];0<(e=e.filter(t=>!this._navimiJSs.isJsLoaded(t))).length&&await Promise.all(e.map(t=>{const e=t.split(".").pop();if("css"!==e.toLowerCase())return this._navimiJSs.fetchJS(void 0,[t]);this._navimiCSSs.fetchCss(void 0,t,!0)})).catch(t=>{throw new Error(t)})}}init(t,e){this._navimiCSSs=t,this._navimiJSs=e}}class __Navimi_Fetch{constructor(){this.loadErrors={},this.init=(t,e)=>{this._bustCache=t.bustCache,this._fetch=e},this.getErrors=t=>this.loadErrors[t],this.fetchFile=(a,e)=>new Promise((i,s)=>{delete this.loadErrors[a];var t=a+(this._bustCache?"?v="+this._bustCache:"");(this._fetch||fetch)(t,e).then(async t=>{var e;if(!t||!t.ok)return this.loadErrors[a]=e="Could not load the file! - "+a,s(e);i(await t.text())}).catch(t=>{this.loadErrors[a]=t.message,s(t)})})}}var __Navimi_Helpers;!function(s){const h=t=>{if(!t)return[];var e=t.indexOf("?");return(t=0<=e?t.substr(0,e):t).split("/").filter(t=>0<t.length)},l=(t,e)=>{var i=t.indexOf("?"),s=0<i?t.substr(i+1,t.length):"";const a=h(t),r=h(e);let n={};0<i&&(n={queryString:(t=>{const e={};return t.split("&").map(t=>{t=t.split("=");e[decodeURIComponent(t[0])]=decodeURIComponent(t[1]||"")}),e})(s)});for(let t=0;t<r.length;t++)if(":"===r[t].charAt(0)){var o=r[t].slice(1);if(a.length<=t)return null;n[o]=decodeURIComponent(a[t])}else if(!a[t]||r[t].toLowerCase()!==a[t].toLowerCase())return null;return n};s.isSameFile=(t,e)=>t&&e&&t.split("?").shift().toLowerCase()==e.split("?").shift().toLowerCase(),s.timeout=e=>new Promise(t=>setTimeout(t,e)),s.debounce=(t,e)=>{let i;return function(){clearTimeout(i),i=setTimeout(()=>{i=null,t.apply(this,arguments)},e)}},s.getUrl=()=>{const t=document.location;var e=t.toString().match(/^[^#]*(#.+)$/);const i=e?e[1]:"";return[t.pathname,t.search,i].join("")},s.removeHash=t=>{var e=t.indexOf("#");return 0<e?t.substr(0,e):t},s.stringify=t=>{const e=[],s=i=>{if("function"==typeof i)return String(i);if(i instanceof Error)return i.message;if(null===i||"object"!=typeof i)return i;if(-1!==e.indexOf(i))return`[Circular: ${e.indexOf(i)}]`;if(e.push(i),Array.isArray(i))return t=i.map(s),e.pop(),t;var t=Object.keys(i).reduce((t,e)=>(t[e]=s(((t,e)=>{if(Object.prototype.hasOwnProperty.call(t,e))try{return t[e]}catch(t){return}return t[e]})(i,e)),t),{});return e.pop(),t};return JSON.stringify(s(t))},s.cloneObject=i=>null===i||"object"!=typeof i?i:Object.keys(i).reduce((t,e)=>(null!==i[e]&&"object"==typeof i[e]?t[e]=s.cloneObject(i[e]):t[e]=i[e],t),Array.isArray(i)?[]:{}),s.getRouteAndParams=(t,e)=>{var i=h(t),s=e["*"];let a,r;for(const o in e){var n=h(o);if(n.length===i.length&&(r=l(t,o))){a=e[o];break}}return{routeItem:a=!a&&s?s:a,params:r}}}(__Navimi_Helpers=__Navimi_Helpers||{});class __Navimi_Hot{constructor(){this.openHotWs=(t,e)=>{},this._digestHot=(t,e,i,s,a,r)=>{}}init(t,e,i){this._navimiCSSs=t,this._navimiJSs=e,this._navimiTemplates=i}}class __Navimi_JSs{constructor(){this._navimiLoaderNS="__navimiLoader",this._callBackNS="_jsLoaderCallback",this._promiseNS="_promise_",this._loadedJSs={},this._externalJSs={},this._routesJSs={},this._dependencyJSsMap={},this._routesJSsServices={},this._awaitJS=s=>new Promise((t,e)=>{const i=setInterval(()=>this._routesJSs[s]?(clearInterval(i),t(this._routesJSs[s])):void 0===this._navimiLoader[this._promiseNS+s]?(clearInterval(i),e("Error loading file! "+s)):void 0,50)}),this._fetch=(s,a,r)=>new Promise(async(e,i)=>{try{let t;t="string"==typeof this._loadedJSs[a]?this._loadedJSs[a]:await this._navimiFetch.fetchFile(a,{headers:{Accept:"application/javascript"},signal:s?s.signal:void 0}),this._insertJS(a,t,r),void 0===r&&this._navimiLoader[this._promiseNS+a](!0),e()}catch(t){i(t)}}),this._insertJS=(t,e,i)=>{var s=void 0!==i?`(function(){window.${this._navimiLoaderNS}.${this._callBackNS}("${t}", ${i}, (function(){return ${e}   
                })())}())`:e;this._loadedJSs[t]=!!i||e,this._navimiDom.insertJS(s,t)},this._instantiateJS=async(i,t,s)=>{const a=this._navimiLoader[this._promiseNS+i],e=this._navimiLoader[this._promiseNS+i+"_reject"];if(setTimeout(()=>{delete this._navimiLoader[this._promiseNS+i],delete this._navimiLoader[this._promiseNS+i+"_reject"]},10),t)return this._externalJSs[i]=s,void(a&&a(Object.freeze(s)));try{this._navimiState.unwatchState(i);var r={addLibrary:this._navimiDom.addLibrary,setTitle:this._navimiDom.setTitle,navigateTo:window.navigateTo,getTemplate:this._navimiTemplates.getTemplate,fetchJS:t=>{const e=Array.isArray(t)?t:[t];return e.map(t=>{this._dependencyJSsMap[t]=Object.assign(Object.assign({},this._dependencyJSsMap[t]||{}),{[i]:!0})}),this.fetchJS(void 0,e,!0)},fetchTemplate:t=>{t=Array.isArray(t)?t:[t];return this._navimiTemplates.fetchTemplate(void 0,t,i)},setState:this._navimiState.setState,getState:this._navimiState.getState,setNavimiLinks:this._navimiDom.setNavimiLinks,unwatchState:t=>this._navimiState.unwatchState(i,t),watchState:(t,e)=>this._navimiState.watchState(i,t,e)};let e={};if(this._routesJSsServices[i]&&0<this._routesJSsServices[i].length){for(;;){if(-1===this._routesJSsServices[i].map(t=>void 0===this._externalJSs[this._options.services[t]]).indexOf(!0))break;if(this._routesJSsServices[i].map(t=>this._options.services[t]).find(t=>this._navimiFetch.getErrors(t)))return;await __Navimi_Helpers.timeout(10)}this._routesJSsServices[i].map(t=>{e=Object.assign(Object.assign({},e),{[t]:this._externalJSs[this._options.services[t]]})})}var n=new s(Object.freeze(r),e);this._routesJSs[i]=n,a&&a(n)}catch(t){e&&e(t)}},this.isJsLoaded=t=>void 0!==this._loadedJSs[t],this.getInstance=t=>this._routesJSs[t],this.fetchJS=(s,t,a)=>{var e=i=>new Promise(async(t,e)=>a&&this._externalJSs[i]?t(this._externalJSs[i]):this._routesJSs[i]?t(this._routesJSs[i]):void(this._navimiLoader[this._promiseNS+i]?await this._awaitJS(i).then(t).catch(e):(this._navimiLoader[this._promiseNS+i]=t,this._navimiLoader[this._promiseNS+i+"_reject"]=e,this._fetch(s,i,a).catch(t=>{this._navimiLoader[this._promiseNS+i+"_reject"](t)}))));return 1<t.length?Promise.all(t.map(e)):e(t[0])},this.loadServices=(e,s,t)=>{if(s&&t&&0!==t.length&&(this._routesJSsServices[s]=this._routesJSsServices[s]||[],t&&0<t.length)){let i=[];const a=t.map(t=>{var e=this._options.services&&this._options.services[t];return void 0===e?i.push(t):(-1===this._routesJSsServices[s].indexOf(t)&&this._routesJSsServices[s].push(t),this._dependencyJSsMap[e]=Object.assign(Object.assign({},this._dependencyJSsMap[e]||{}),{[s]:!0})),e});if(0<i.length)throw new Error("Service(s) not defined: "+i.join(", "));Promise.all(a.filter(t=>void 0!==t).map(t=>this.fetchJS(e,[t],!0)))}},this.initJS=async(t,e)=>{const i=this.getInstance(t);i&&i.init&&await i.init(e)},this.reloadJs=(t,e,i,s,a)=>{const r=__Navimi_Helpers.isSameFile;for(const n in i){const o=i[n]["jsUrl"];if(r(o,t))return console.log(t+" updated."),delete this._routesJSs[o],this._navimiLoader[this._promiseNS+o]=()=>{o===s&&a()},void this._insertJS(o,e,!1)}for(const h in this._dependencyJSsMap)r(h,t)&&(console.log(t+" updated."),delete this._externalJSs[h],this._navimiLoader[this._promiseNS+h]=()=>{Object.keys(this._dependencyJSsMap[h]).map(t=>{delete this._routesJSs[t],t===s&&a()})},this._insertJS(t,e,!0))}}init(t,e,i,s,a){this._navimiDom=t,this._navimiFetch=e,this._navimiTemplates=i,this._navimiState=s,this._options=a,this._navimiLoader=window[this._navimiLoaderNS]={[this._callBackNS]:this._instantiateJS}}}class __Navimi_Middleware{constructor(){this._middlewareStack=[],this.addMiddlewares=t=>{Array.isArray(t)&&this._middlewareStack.push(...t.filter(t=>void 0!==t))},this.executeMiddlewares=async(r,e,n)=>{let o=-1;const h=async(i,s,a=0)=>{o=a;const t=this._middlewareStack[a];t?await t(e,async(t,e)=>{r.signal.aborted?s():t?(s(),n(t,e)):await h(i,s,a+1)}):i()};await new Promise(await h).catch(t=>{})}}}class Navimi{constructor(t,e){const i=new __Navimi_Fetch,s=new __Navimi_Dom,a=new __Navimi_CSSs,r=new __Navimi_JSs,n=new __Navimi_Templates;var o=new __Navimi_Middleware,h=new __Navimi_State;const l=new __Navimi_Hot;return i.init(e),a.init(s,i),s.init(a,r),r.init(s,i,n,h,e),n.init(i),new __Navimi_Core(t,e,{navimiFetch:i,navimiJs:r,navimiCss:a,navimiDom:s,navimiTemplates:n,navimiMiddleware:o,navimiState:h,navimiHot:l})}}class __Navimi_State{constructor(){this.state={},this.stateWatchers={},this.prevState={},this.stateDiff={},this.getStateDiff=t=>{t.sort((t,e)=>e.length-t.length).map(e=>{this.stateDiff[e]||__Navimi_Helpers.stringify(this.getState(e,this.prevState)||"")!==__Navimi_Helpers.stringify(this.getState(e,this.state)||"")&&(this.stateDiff[e]=!0,t.map(t=>{e!==t&&0===e.indexOf(t)&&(this.stateDiff[t]=!0)}))})},this.invokeStateWatchers=__Navimi_Helpers.debounce(()=>{const t=Object.keys(this.stateWatchers),e=Object.keys(this.stateDiff);this.stateDiff={},t.filter(t=>e.includes(t)).sort((t,e)=>e.length-t.length).map(i=>{Object.keys(this.stateWatchers[i]).map(t=>{const e=this.getState(i);this.stateWatchers[i][t]&&this.stateWatchers[i][t].map(t=>t&&t(e))})})},10),this.mergeState=(t,e)=>{e instanceof Error&&(e=Object.assign(Object.assign({},e),{message:e.message,stack:e.stack}));var i=t=>t&&"object"==typeof t&&!Array.isArray(t)&&null!==t;if(i(t)&&i(e))for(const s in e)i(e[s])?(t[s]||Object.assign(t,{[s]:{}}),this.mergeState(t[s],e[s])):Object.assign(t,{[s]:e[s]})},this.setState=t=>{var e=Object.keys(this.stateWatchers);0<e.length&&(this.prevState=__Navimi_Helpers.cloneObject(this.state)),this.mergeState(this.state,t),0<e.length&&(this.getStateDiff(e),this.invokeStateWatchers())},this.getState=(t,e)=>{t=t?t.split(".").reduce((t,e)=>t&&t[e]||void 0,e||this.state):e||this.state;return t?Object.freeze(__Navimi_Helpers.cloneObject(t)):void 0},this.watchState=(t,e,i)=>{e&&i&&(this.stateWatchers[e]||(this.stateWatchers[e]={}),this.stateWatchers[e]=Object.assign(Object.assign({},this.stateWatchers[e]),{[t]:[...this.stateWatchers[e][t]||[],i]}))},this.unwatchState=(e,t)=>{const i=t=>{this.stateWatchers[t][e]=void 0,delete this.stateWatchers[t][e],0===Object.keys(this.stateWatchers[t]).length&&delete this.stateWatchers[t]};if(t){const s=Array.isArray(t)?t:[t];void s.map(t=>{this.stateWatchers[t]||(this.stateWatchers[t]={}),i(t)})}else Object.keys(this.stateWatchers).map(i)}}}class __Navimi_Templates{constructor(){this._templatesCache={},this._loadedTemplates={},this._dependencyTemplatesMap={},this.loadTemplate=(t,e)=>{const i=new RegExp("<t ([^>]+)>"),s=new RegExp("</t>"),a=new RegExp('id="([^"]+)"');let r=t;if(i.exec(r))for(;t&&0<t.length;){var n=i.exec(r);if(!n||0===n.length)break;var o=a.exec(n[1]),o=0<o.length&&o[1],n=(r=r.substr(n.index+n[0].length),s.exec(r));if(!o||!n||0===n.length)break;this._templatesCache[o]=r.substr(0,n.index)}else this._templatesCache[e]=r},this.isTemplateLoaded=t=>void 0!==this._loadedTemplates[t],this.getTemplate=t=>{const e=Array.isArray(t)?t:[t];t=e.map(t=>this._templatesCache[t]);return 1<t.length?t:t[0]},this.fetchTemplate=(a,t,e)=>{var i=s=>new Promise(async(t,e)=>{if(!s||this._loadedTemplates[s])return t();try{var i=await this._navimiFetch.fetchFile(s,{headers:{Accept:"text/html"},signal:a?a.signal:void 0});this.loadTemplate(i,s),this._loadedTemplates[s]=!0,t()}catch(t){e(t)}});return e&&t.map(t=>{this._dependencyTemplatesMap[t]=Object.assign(Object.assign({},this._dependencyTemplatesMap[t]||{}),{[e]:!0})}),1<t.length?Promise.all(t.map(i)):i(t[0])},this.reloadTemplate=(t,e,i,s,a,r)=>{const n=__Navimi_Helpers.isSameFile;if(n(a,t))return console.log(t+" updated."),this.loadTemplate(e,a),void r();for(const h in i){var{jsUrl:c,templatesUrl:o}=i[h];if(n(o,t))return console.log(t+" updated."),this.loadTemplate(e,o),void(s===c&&r())}for(const l in this._dependencyTemplatesMap)n(l,t)&&(console.log(t+" updated."),this.loadTemplate(e,l),Object.keys(this._dependencyTemplatesMap[l]).map(t=>{t===s&&r()}))}}init(t){this._navimiFetch=t}}class INavimi_Helpers{}