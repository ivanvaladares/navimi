/**
 * Navimi v0.2.2 
 * Developed by Ivan Valadares 
 * ivanvaladares@hotmail.com 
 * https://github.com/ivanvaladares/navimi 
 */ 
class __Navimi_Components{constructor(){this._components={},this._removeComponent=t=>{t.localName&&t.__rendered&&this._components[t.localName]&&(t.__rendered=!1,this._removeChildComponents(t),this._disconnectComponent(t),t.remove(),t.onUnmount&&t.onUnmount())},this._disconnectComponent=e=>{e.parentComponent&&(e.parentComponent.childComponents=e.parentComponent.childComponents.filter(t=>t!==e))},this._removeChildComponents=t=>{t.childComponents&&t.childComponents.map(t=>{this._removeComponent(t)})},this._readAttributes=t=>{var e,i=t.props;t.props={};for(e of[].slice.call(t.attributes)){var s=e.name;"function"!=typeof t[s]&&(t.props=Object.assign(Object.assign({},t.props||{}),{[s]:e.value}))}return i},this._traverseTree=(e,i)=>{if(e.localName)if(this._components[e.localName])i(e);else{let t;for(t of e.children)this._traverseTree(t,i)}},this._registerTag=async(t,e)=>{if(!t.props){const i=this._components[t.localName];t.props={},t.__rendered=!1,t.__previousTemplate=void 0,t.__initalInnerHTML=t.innerHTML,t.innerHTML="",t.parentComponent=void 0,t.childComponents=[],this._findParentComponent(t,e),this._readAttributes(t),Object.setPrototypeOf(t,new i(t.props)),t.update=this._navimiHelpers.throttle(t.render,10,t),await t.init()}},this._findParentComponent=(e,t)=>{var i=t=>{(e.parentComponent=t).childComponents=[...t.childComponents||[],e]};if(t)i(t);else{let t=e.parentNode;for(;t;){if(/\-/.test(t.localName)&&this._components[t.localName])return void i(t);t=t.parentNode}}},this._registerChildEvents=(t,e)=>{if(e.attributes)for(var i of[].slice.call(e.attributes)){i=i.name;"function"==typeof e[i]&&(e[i]=e[i].bind(t))}},this._registerChildComponents=i=>{const s=t=>{let e;for(e of t.childNodes)this._components[e.localName]?this._registerTag(e,i):(this._registerChildEvents(i,e),s(e))};s(i)},this.mergeHtml=(t,i)=>{var s=t=>3===t.nodeType?"text":8===t.nodeType?"comment":t.tagName.toLowerCase(),r=t=>t.childNodes&&0<t.childNodes.length?null:t.textContent,a=[].slice.call(t.childNodes);let n=[].slice.call(i.childNodes),o=n.length-a.length;for(let e=0;e<a.length;e++){let t=a[e];if(n[e])if(s(t)!==s(n[e]))0<o?(this._traverseTree(n[e],this._removeComponent),n[e].parentNode&&n[e].parentNode.removeChild(n[e]),e--):i.insertBefore(t.cloneNode(!0),n[e]),n=[].slice.call(i.childNodes);else{var h=r(t);if(h&&h!==r(n[e])&&(n[e].textContent=h),t.localName){if(t.localName===n[e].localName){const c=[].slice.call(n[e].attributes),m=[].slice.call(t.attributes);var h=m.filter(e=>c.find(t=>e.name===t.name&&e.value!==t.value));const _=c.filter(e=>!m.find(t=>e.name===t.name));var l=m.filter(e=>!c.find(t=>e.name===t.name));_.map(t=>{n[e].removeAttribute(t.name)}),[...h,...l].map(t=>{n[e].setAttribute(t.name,t.value)})}this._components[t.localName]||(0<n[e].childNodes.length&&t.childNodes.length<1?n[e].innerHTML="":n[e].childNodes.length<1&&0<t.childNodes.length?(h=document.createDocumentFragment(),this.mergeHtml(t,h),n[e].appendChild(h)):0<t.childNodes.length&&this.mergeHtml(t,n[e]))}}else i.appendChild(t.cloneNode(!0))}for(o=n.length-a.length;0<o;){var e=n.length-o;this._traverseTree(n[e],this._removeComponent),n[e].parentNode&&n[e].parentNode.removeChild(n[e]),o--}},this._createComponentClass=(t,s,r)=>class extends t{constructor(t){super(t)}async init(){super.init&&await super.init(),await this.render(),super.onMount&&await super.onMount()}async render(){this.__rendered=!0;var t=super.render&&await super.render(this.__initalInnerHTML);if(t&&t!==this.__previousTemplate){this.__previousTemplate=t;const e=new DOMParser,i=e.parseFromString(t,"text/html");r(i.querySelector("body"),this),s(this)}super.onRender&&super.onRender()}},this.registerComponent=(t,e)=>{!this._components[t]&&/\-/.test(t)&&(Object.setPrototypeOf(e.prototype,HTMLElement.prototype),this._components[t]=this._createComponentClass(e,this._registerChildComponents,this.mergeHtml))}}init(t){this._components={},this._navimiHelpers=t,new MutationObserver(t=>{for(const i of t)if("attributes"===i.type){const s=i.target;var e;this._components[s.localName]&&(e=this._readAttributes(s),s.shouldUpdate&&!s.shouldUpdate(e,s.props)||s.update())}else{for(const r of i.addedNodes)this._traverseTree(r,this._registerTag);for(const a of i.removedNodes)this._traverseTree(a,this._removeComponent)}}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0})}}class __Navimi_Core{constructor(t,e,i){this._navigateTo=(t,e)=>{this._initRoute(t,e)},this._reportError=t=>{this._options.onError?this._options.onError(t):console.error(t)},this._initRoute=async(t,e,i)=>{var s=this._navimiHelpers.removeHash(t||this._navimiHelpers.getUrl());if(!i){if(this._currentUrl===s)return;this._abortController&&this._abortController.abort(),this._abortController=window.AbortController?new AbortController:void 0}var r=++this._callId,a=void 0!==t;let{routeItem:n,params:o}=this._navimiHelpers.getRouteAndParams(s,this._routesList);if(void 0!==e&&(o=Object.assign(Object.assign({},o),e)),this._currentJS&&!i){if(this._options.onBeforeRoute)if(!1===await this._options.onBeforeRoute({url:s,routeItem:n,params:o},this._navigateTo))return;const v=this._navimiJSs.getInstance(this._currentJS);if(v){const u=v.beforeLeave;if(u)if(!1===u({url:s,routeItem:n,params:o}))return void(a||history.forward());v.destroy&&v.destroy()}}if(n){if(await this._navimiMiddlewares.executeMiddlewares(this._abortController,{url:s,routeItem:n,params:o},(t,e)=>{this._initRoute(t,e,!0)}).catch(this._reportError),!(r<this._callId)){this._currentUrl=s;try{var{title:h,jsUrl:l,cssUrl:c,templatesUrl:m,services:_,components:d}=n||{};if(!l&&!m)throw new Error("The route must define the 'jsUrl' or 'templatesUrl'!");l&&(this._currentJS=l,this._routesParams[l]={url:s,routeItem:n,params:o}),a&&(null!=e&&e.replaceUrl?history.replaceState(null,null,t):history.pushState(null,null,t)),this._navimiCSSs.fetchCss(this._abortController,c).catch(t=>{}),this._navimiTemplates.fetchTemplate(this._abortController,m).catch(t=>{});try{await this._navimiJSs.loadDependencies(this._abortController,l||s,_,d)}catch(t){this._reportError(t)}for(l&&await this._navimiJSs.fetchJS(this._abortController,[l],"route");c&&!this._navimiCSSs.isCssLoaded(c)||m&&!this._navimiTemplates.isTemplateLoaded(m)||this._options.globalCssUrl&&!this._navimiCSSs.isCssLoaded(this._options.globalCssUrl)||this._options.globalTemplatesUrl&&!this._navimiTemplates.isTemplateLoaded(this._options.globalTemplatesUrl);){if(await this._navimiHelpers.timeout(10),r<this._callId)return;if(c&&this._navimiFetch.getErrors(c)||m&&this._navimiFetch.getErrors(m)||this._options.globalCssUrl&&this._navimiFetch.getErrors(this._options.globalCssUrl)||this._options.globalTemplatesUrl&&this._navimiFetch.getErrors(this._options.globalTemplatesUrl))return void this._reportError(new Error(this._navimiFetch.getErrors(c)||this._navimiFetch.getErrors(m)||this._navimiFetch.getErrors(this._options.globalCssUrl)||this._navimiFetch.getErrors(this._options.globalTemplatesUrl)))}this._navimiDom.setTitle(h);try{if(!l){var p=this._navimiTemplates.getTemplate(m);const f=document.querySelector("body");return void(p&&f&&(f.innerHTML=p))}await this._navimiJSs.initJS(l,this._routesParams[l])}catch(t){this._reportError(t)}finally{if(r<this._callId)return;this._navimiDom.setNavimiLinks(),this._navimiDom.insertCss(this._navimiCSSs.getCss(c),c,"routeCss"),this._options.onAfterRoute&&this._options.onAfterRoute({url:s,routeItem:n,params:o},this._navigateTo)}}catch(t){this._reportError(t)}}}else r===this._callId&&this._reportError(new Error("No route match for url: "+s))},this._callId=0,this._abortController=window.AbortController?new AbortController:void 0,this._currentJS,this._currentUrl,this._routesParams={},this._routesList=t||{},this._options=i||{},this._win=window||{},this._navimiFetch=e.navimiFetch,this._navimiDom=e.navimiDom,this._navimiCSSs=e.navimiCSSs,this._navimiJSs=e.navimiJSs,this._navimiTemplates=e.navimiTemplates,this._navimiMiddlewares=e.navimiMiddlewares,this._navimiHot=e.navimiHot,this._navimiHelpers=e.navimiHelpers,this._win.addEventListener("popstate",()=>{this._initRoute()}),this._win.navigateTo=this._navigateTo,this._navimiMiddlewares.addMiddlewares(this._options.middlewares),(async()=>{await this._init()})(),this._initRoute(),this._options.hot&&this._initHot()}async _init(){(this._options.globalCssUrl||this._options.globalTemplatesUrl)&&await Promise.all([this._navimiCSSs.fetchCss(void 0,this._options.globalCssUrl),this._navimiTemplates.fetchTemplate(void 0,this._options.globalTemplatesUrl)]).then(()=>{this._navimiDom.insertCss(this._navimiCSSs.getCss(this._options.globalCssUrl),this._options.globalCssUrl,"globalCss")}).catch(this._reportError)}_initHot(){}}class __Navimi_CSSs{constructor(){this._loadedCsss={},this.isCssLoaded=t=>void 0!==this._loadedCsss[t],this.getCss=t=>this._loadedCsss[t],this.fetchCss=(s,r)=>new Promise(async(t,e)=>{if(!r||this._loadedCsss[r])return t(this._loadedCsss[r]);try{var i=await this._navimiFetch.fetchFile(r,{headers:{Accept:"text/css"},signal:s?s.signal:void 0});t(this._loadedCsss[r]=i)}catch(t){e(t)}})}init(t,e){this._navimiDom=t,this._navimiFetch=e}}class __Navimi_Dom{constructor(){this.setTitle=t=>{document.title=t},this.setNavimiLinks=()=>{document.querySelectorAll("[navimi-link]").forEach(t=>{t.removeAttribute("navimi-link"),t.setAttribute("navimi-linked",""),t.addEventListener("click",t=>{t.preventDefault(),window.navigateTo(t.target.pathname)})})},this.insertCss=(t,e,i,s)=>{var r;if(null!=(r=document.querySelector(`[cssUrl='${e}']`))&&r.remove(),"routeCss"===i&&null!=(r=document.querySelector(`[cssType='${i}']`))&&r.remove(),t){const a=document.createElement("style");a.innerHTML=t,e&&a.setAttribute("cssUrl",e),e&&a.setAttribute("cssType",i);const n=document.getElementsByTagName("head")[0]||document.body;s?n.prepend(a):n.appendChild(a)}},this.replaceCss=(t,e)=>{const i=e?document.querySelector(`[cssUrl='${e}']`):void 0;i&&(i.innerHTML=t)},this.insertJS=(t,e,i)=>{const s=document.querySelector(`[jsUrl='${e}']`),r=(s&&s.remove(),document.createElement("script")),a=(r.type=i?"module":"text/javascript",r.innerHTML=t,r.setAttribute("jsUrl",e),document.getElementsByTagName("head")[0]);(a||document.body).appendChild(r)},this.addLibrary=async t=>{const e=Array.isArray(t)?t:[t];let i=e.map(t=>{if("string"!=typeof t)return t;{const e=t.split(".").pop();return{url:t,type:"css"===e.toLowerCase()?"css":"jsLibrary"}}}).filter(t=>!this._navimiJSs.isJsLoaded(t.url));0<i.length&&await Promise.all(i.map(e=>{var t;if("css"!==e.type.toLowerCase())return t="module"===e.type.toLowerCase()?"module":"library",this._navimiJSs.fetchJS(void 0,[e.url],t);this._navimiCSSs.fetchCss(void 0,e.url).then(t=>{this.insertCss(t,e.url,"library",!0)})})).catch(t=>{throw new Error(t)})}}init(t,e){this._navimiCSSs=t,this._navimiJSs=e}}class __Navimi_Fetch{constructor(){this.loadErrors={},this.init=t=>{this._bustCache=t.bustCache},this.getErrors=t=>this.loadErrors[t],this.fetchFile=(r,e)=>new Promise((i,s)=>{delete this.loadErrors[r];var t=r+(this._bustCache?"?v="+this._bustCache:"");fetch(t,e).then(async t=>{var e;if(!t||!t.ok)return this.loadErrors[r]=e="Could not load the file! - "+r,s(e);i(await t.text())}).catch(t=>{this.loadErrors[r]=t.message,s(t)})})}}class __Navimi_Helpers{constructor(){this.parseQuery=t=>{const e={};return t.split("&").map(t=>{t=t.split("=");e[decodeURIComponent(t[0])]=decodeURIComponent(t[1]||"")}),e},this.splitPath=t=>{if(!t)return[];var e=t.indexOf("?");return(t=0<=e?t.substr(0,e):t).split("/").filter(t=>0<t.length)},this.parsePath=(t,e)=>{var i=t.indexOf("?"),s=0<i?t.substr(i+1,t.length):"";const r=this.splitPath(t),a=this.splitPath(e);let n={};0<i&&(n={queryString:this.parseQuery(s)});for(let t=0;t<a.length;t++)if(":"===a[t].charAt(0)){var o=a[t].slice(1);if(r.length<=t)return null;n[o]=decodeURIComponent(r[t])}else if(!r[t]||a[t].toLowerCase()!==r[t].toLowerCase())return null;return n},this.timeout=e=>new Promise(t=>setTimeout(t,e)),this.debounce=(t,e)=>{let i;return function(){clearTimeout(i),i=setTimeout(()=>{i=null,t.apply(this,arguments)},e)}},this.throttle=(i,s,r)=>{let a,n;return function(){const t=arguments,e=Date.now();n&&e<n+s?(clearTimeout(a),a=setTimeout(()=>{n=e,i.apply(r,t)},s)):(n=e,i.apply(r,t))}},this.getUrl=()=>{const t=document.location;var e=t.toString().match(/^[^#]*(#.+)$/);const i=e?e[1]:"";return[t.pathname,t.search,i].join("")},this.removeHash=t=>{var e=t.indexOf("#");return 0<e?t.substr(0,e):t},this.stringify=t=>{const e=[],s=i=>{if("function"==typeof i)return String(i);if(i instanceof Error)return i.message;if(null===i||"object"!=typeof i)return i;if(-1!==e.indexOf(i))return`[Circular: ${e.indexOf(i)}]`;if(e.push(i),Array.isArray(i))return t=i.map(s),e.pop(),t;var t=Object.keys(i).reduce((t,e)=>(t[e]=s(((t,e)=>{if(Object.prototype.hasOwnProperty.call(t,e))try{return t[e]}catch(t){return}return t[e]})(i,e)),t),{});return e.pop(),t};return JSON.stringify(s(t))},this.cloneObject=i=>null===i||"object"!=typeof i?i:Object.keys(i).reduce((t,e)=>(null!==i[e]&&"object"==typeof i[e]?t[e]=this.cloneObject(i[e]):t[e]=i[e],t),Array.isArray(i)?[]:{}),this.getRouteAndParams=(t,e)=>{var i=this.splitPath(t),s=e["*"];let r,a;for(const o in e){var n=this.splitPath(o);if(n.length===i.length&&(a=this.parsePath(t,o))){r=e[o];break}}return!r&&s&&(a=this.parsePath(t,t),r=s),{routeItem:r,params:a}}}}class __Navimi_Hot{constructor(){this.openHotWs=t=>{try{if(!("WebSocket"in window))return void console.error("Websocket is not supported by your browser!");console.warn("Connecting HOT...");var e=!0===t?8080:t;this._wsHotClient=null,this._wsHotClient=new WebSocket("ws://localhost:"+e),this._wsHotClient.addEventListener("message",t=>{try{var e=JSON.parse(t.data||"");if(e.message)return void console.warn(e.message);e.filePath&&this._digestHot(e)}catch(t){console.error("Could not parse HOT message:",t)}}),this._wsHotClient.onclose=()=>{console.warn("HOT Connection Closed!"),setTimeout(this.openHotWs,5e3,t)}}catch(t){console.error(t)}},this._digestHot=t=>{var e;try{const i=t.filePath.replace(/\\/g,"/");switch(null==(e=i.split(".").pop())?void 0:e.toLocaleLowerCase()){case"css":this._navimiCSSs.digestHot(t);break;case"html":case"htm":this._navimiTemplates.digestHot(t).then(()=>this._initRouteFunc());break;case"js":this._navimiJSs.digestHot(t).then(()=>this._initRouteFunc());break;case"gif":case"jpg":case"jpeg":case"png":case"svg":this._initRouteFunc()}}catch(t){console.error("Could not digest HOT payload: ",t)}}}init(t,e,i,s){this._navimiCSSs=t,this._navimiJSs=e,this._navimiTemplates=i,this._initRouteFunc=s}}class __Navimi_JSs{constructor(){this._navimiLoaderNS="__navimiLoader",this._callBackNS="_jsLoaderCallback",this._promiseNS="_promise_",this._loadedJSs={},this._jsType={},this._jsInstances={},this._dependencyJSsMap={},this._routesJSsServices={},this._routesJSsComponents={},this._resolvePromise=(t,e)=>{this._navimiLoader[this._promiseNS+e](t)},this._rejectPromise=(t,e)=>{this._navimiLoader[this._promiseNS+e+"_reject"](t)},this._awaitJS=r=>new Promise((e,i)=>{const s=setInterval(()=>{if(this._jsInstances[r])return clearInterval(s),e(this._jsInstances[r]);var t=this._navimiFetch.getErrors(r);return t?(clearInterval(s),i(t)):void 0},10)}),this._fetch=(s,r,a)=>new Promise(async(e,i)=>{try{let t;t=this._loadedJSs[r]||await this._navimiFetch.fetchFile(r,{headers:{Accept:"application/javascript"},signal:s?s.signal:void 0}),this._jsType[r]=a,this._insertJS(r,t,a),"route"!==a&&"service"!==a&&this._resolvePromise(!0,r),e()}catch(t){i(t)}}),this._insertJS=(t,e,i)=>{var s="module"===i||"library"===i?e:`(function(){window.${this._navimiLoaderNS}.${this._callBackNS}("${t}", "${i}", (function(){return ${e}   
                })())}())`;this._loadedJSs[t]=e,this._navimiDom.insertJS(s,t,"module"===i)},this._instantiateJS=async(i,t,s)=>{if(setTimeout(()=>{delete this._navimiLoader[this._promiseNS+i],delete this._navimiLoader[this._promiseNS+i+"_reject"]},10),"route"!==t)return this._jsInstances[i]=s,void this._resolvePromise(Object.freeze(s),i);try{this._navimiState.unwatchState(i);var r={addLibrary:this._navimiDom.addLibrary,setTitle:this._navimiDom.setTitle,navigateTo:window.navigateTo,getTemplate:this._navimiTemplates.getTemplate,fetchJS:t=>{const e=Array.isArray(t)?t:[t];return e.map(t=>{this._dependencyJSsMap[t]=Object.assign(Object.assign({},this._dependencyJSsMap[t]||{}),{[i]:!0})}),this.fetchJS(void 0,e,"javascript")},fetchTemplate:t=>this._navimiTemplates.fetchTemplate(void 0,t),setState:this._navimiState.setState,getState:this._navimiState.getState,setNavimiLinks:this._navimiDom.setNavimiLinks,unwatchState:t=>this._navimiState.unwatchState(i,t),watchState:(t,e)=>this._navimiState.watchState(i,t,e)};let e={};this._routesJSsServices[i].map(t=>{e=Object.assign(Object.assign({},e),{[t]:this._jsInstances[this._options.services[t]]})});var a=new s(Object.freeze(r),e);this._jsInstances[i]=a,this._resolvePromise(a,i)}catch(t){this._rejectPromise(t,i)}},this._isJsLoading=t=>void 0!==this._navimiLoader[this._promiseNS+t],this.isJsLoaded=t=>void 0!==this._loadedJSs[t],this.getInstance=t=>this._jsInstances[t],this.fetchJS=(s,t,r)=>{var e=i=>new Promise(async(t,e)=>{if(this._jsInstances[i])return t(this._jsInstances[i]);this._isJsLoading(i)?await this._awaitJS(i).then(t).catch(e):(this._navimiLoader[this._promiseNS+i]=t,this._navimiLoader[this._promiseNS+i+"_reject"]=e,this._fetch(s,i,r).catch(e))});return 1<t.length?Promise.all(t.map(e)):e(t[0])},this.loadDependencies=async(e,r,t,i)=>{if(r){var s=(t,i)=>{const s=[];t=(t||[]).map(t=>{var e=this._options[i]&&this._options[i][t];return void 0===e?s.push(t):("services"===i&&-1===this._routesJSsServices[r].indexOf(t)&&this._routesJSsServices[r].push(t),"components"===i&&-1===this._routesJSsComponents[r].indexOf(t)&&this._routesJSsComponents[r].push(t),this._dependencyJSsMap[e]=Object.assign(Object.assign({},this._dependencyJSsMap[e]||{}),{[r]:!0})),e});if(0<s.length)throw new Error(i+" not defined: "+s.join(", "));return t};this._routesJSsServices[r]=this._routesJSsServices[r]||[],this._routesJSsComponents[r]=this._routesJSsComponents[r]||[];const a=s(t,"services"),n=s(i,"components");Promise.all(a.filter(t=>void 0!==t).map(t=>this.fetchJS(e,[t],"service"))),Promise.all(n.filter(t=>void 0!==t).map(i=>this.fetchJS(e,[i],"component").then(e=>{Object.keys(this._options.components).map(t=>{this._options.components[t]===i&&this._navimiComponents.registerComponent(t,e)})}))),await Promise.all(a.map(this._awaitJS)),await Promise.all(n.map(this._awaitJS))}},this.initJS=async(t,e)=>{const i=this.getInstance(t);i&&i.init&&await i.init(e)}}init(t,e,i,s,r,a){this._navimiDom=t,this._navimiFetch=e,this._navimiTemplates=i,this._navimiState=s,this._navimiComponents=r,this._options=a,this._navimiLoader=window[this._navimiLoaderNS]={[this._callBackNS]:this._instantiateJS}}}class __Navimi_Middlewares{constructor(){this._middlewareStack=[],this.addMiddlewares=t=>{Array.isArray(t)&&this._middlewareStack.push(...t.filter(t=>void 0!==t))},this.executeMiddlewares=async(a,e,n)=>{let o;const h=async(i,s,r=0)=>{o=r;const t=this._middlewareStack[r];if(t)try{await t(e,async(t,e)=>{a&&a.signal.aborted?i():t?(n(t,e),i()):await h(i,s,r+1)})}catch(t){s(t)}else i()};return new Promise(h)}}}class Navimi{constructor(t,e,i,s){const r=null!=(l=null==i?void 0:i.navimiFetch)?l:new __Navimi_Fetch,a=null!=(l=null==i?void 0:i.navimiDom)?l:new __Navimi_Dom,n=null!=(l=null==i?void 0:i.navimiCSSs)?l:new __Navimi_CSSs,o=null!=(l=null==i?void 0:i.navimiJSs)?l:new __Navimi_JSs,h=null!=(l=null==i?void 0:i.navimiTemplates)?l:new __Navimi_Templates;var l=null!=(l=null==i?void 0:i.navimiMiddlewares)?l:new __Navimi_Middlewares;const c=null!=(m=null==i?void 0:i.navimiState)?m:new __Navimi_State;var m=null!=(m=null==i?void 0:i.navimiHot)?m:new __Navimi_Hot,_=null!=(_=null==i?void 0:i.navimiHelpers)?_:new __Navimi_Helpers;const d=null!=(i=null==i?void 0:i.navimiComponents)?i:new __Navimi_Components;r.init(e),n.init(a,r),a.init(n,o),o.init(a,r,h,c,d,e),h.init(r),c.init(_),d.init(_);i={navimiFetch:r,navimiJSs:o,navimiCSSs:n,navimiDom:a,navimiTemplates:h,navimiMiddlewares:l,navimiState:c,navimiHot:m,navimiHelpers:_,navimiComponents:d};return s?s(t,i,e):new __Navimi_Core(t,i,e)}}class __Navimi_State{constructor(){this.state={},this.stateWatchers={},this.prevState={},this.stateDiff={},this._navimiHelpers={},this.getStateDiff=t=>{t.sort((t,e)=>e.length-t.length).map(e=>{this.stateDiff[e]||this._navimiHelpers.stringify(this.getState(e,this.prevState)||"")!==this._navimiHelpers.stringify(this.getState(e,this.state)||"")&&(this.stateDiff[e]=!0,t.map(t=>{e!==t&&0===e.indexOf(t)&&(this.stateDiff[t]=!0)}))})},this.mergeState=(t,e)=>{e instanceof Error&&(e=Object.assign(Object.assign({},e),{message:e.message,stack:e.stack}));var i=t=>t&&"object"==typeof t&&!Array.isArray(t)&&null!==t;if(i(t)&&i(e))for(const s in e)i(e[s])?(t[s]||Object.assign(t,{[s]:{}}),this.mergeState(t[s],e[s])):Object.assign(t,{[s]:e[s]})},this.setState=t=>{var e=Object.keys(this.stateWatchers);0<e.length&&(this.prevState=this._navimiHelpers.cloneObject(this.state)),this.mergeState(this.state,t),0<e.length&&(this.getStateDiff(e),this.invokeStateWatchers())},this.getState=(t,e)=>{t=t?t.split(".").reduce((t,e)=>t&&t[e]||void 0,e||this.state):e||this.state;return t?Object.freeze(this._navimiHelpers.cloneObject(t)):void 0},this.watchState=(t,e,i)=>{e&&i&&(this.stateWatchers[e]||(this.stateWatchers[e]={}),this.stateWatchers[e]=Object.assign(Object.assign({},this.stateWatchers[e]),{[t]:[...this.stateWatchers[e][t]||[],i]}))},this.unwatchState=(e,t)=>{const i=t=>{this.stateWatchers[t][e]=void 0,delete this.stateWatchers[t][e],0===Object.keys(this.stateWatchers[t]).length&&delete this.stateWatchers[t]};if(t){const s=Array.isArray(t)?t:[t];void s.map(t=>{this.stateWatchers[t]||(this.stateWatchers[t]={}),i(t)})}else Object.keys(this.stateWatchers).map(i)},this.clear=t=>{const e=Array.isArray(t)?t:[t];console.log("clear",e),e.map(e=>{const i=e?e.split(".").reduce((t,e)=>t&&t[e]||void 0,this.state):this.state;console.log(e),i instanceof Object&&Object.keys(i).map(t=>{i[t]instanceof Object&&this.clear(e+"."+t),delete i[t]})})}}init(t){this._navimiHelpers=t,this.invokeStateWatchers=t.debounce(()=>{const t=Object.keys(this.stateWatchers),e=Object.keys(this.stateDiff);this.stateDiff={},t.filter(t=>0<=e.indexOf(t)).sort((t,e)=>e.length-t.length).map(i=>{Object.keys(this.stateWatchers[i]).map(t=>{const e=this.getState(i);this.stateWatchers[i][t]&&this.stateWatchers[i][t].map(t=>t&&t(e))})})},10)}}class __Navimi_Templates{constructor(){this._templatesCache={},this._loadedTemplates={},this.loadTemplate=(t,e)=>{let i=t;if(this._regIni.exec(i))for(;t&&0<t.length;){var s=this._regIni.exec(i);if(!s||0===s.length)break;const a=this._regId.exec(s[1]);var r=0<a.length&&a[1].slice(1,-1),s=(i=i.substr(s.index+s[0].length),this._regEnd.exec(i));if(!r||!s||0===s.length)break;this._templatesCache[r]=i.substr(0,s.index)}else this._templatesCache[e]=i},this.isTemplateLoaded=t=>void 0!==this._loadedTemplates[t],this.getTemplate=t=>{const e=Array.isArray(t)?t:[t];t=e.map(t=>this._templatesCache[t]);return 1<t.length?t:t[0]},this.fetchTemplate=(r,t)=>{var e=s=>new Promise(async(t,e)=>{if(!s||this._loadedTemplates[s])return t();try{var i=await this._navimiFetch.fetchFile(s,{headers:{Accept:"text/html"},signal:r?r.signal:void 0});this.loadTemplate(i,s),this._loadedTemplates[s]=!0,t()}catch(t){e(t)}});const i=Array.isArray(t)?t:[t];return 1<i.length?Promise.all(i.map(e)):e(i[0])}}init(t){this._navimiFetch=t,this._regIni=new RegExp("<t ([^>]+)>"),this._regEnd=new RegExp("</t>"),this._regId=new RegExp("id=(\"[^\"]+\"|'[^']+')")}}