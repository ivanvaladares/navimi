class Navimi{constructor(t,e){this.timeout=(t=>new Promise(e=>setTimeout(e,t))),this.debounce=((t,e)=>{let s;return function(){clearTimeout(s),s=setTimeout(()=>{s=null,t.apply(this,arguments)},e)}}),this.setNavimiLinks=(()=>{document.querySelectorAll("[navimi-link]").forEach(t=>{t.removeAttribute("navimi-link"),t.setAttribute("navimi-linked",""),t.addEventListener("click",t=>{t.preventDefault(),this.navigateTo(t.target.pathname)})})}),this.navigateTo=((t,e)=>{this.initRoute(t,e)}),this.setTitle=(t=>{document.title=t}),this.getUrl=(()=>{const t=document.location,e=t.toString().match(/^[^#]*(#.+)$/),s=e?e[1]:"";return[t.pathname,t.search,s].join("")}),this.splitPath=(t=>{if(!t)return[];const e=t.indexOf("?");return(t=e>=0?t.substr(0,e):t).split("/").filter(t=>t.length>0)}),this.removeHash=(t=>{const e=t.indexOf("#");return e>0?t.substr(0,e):t}),this.parseQuery=(t=>{const e={};return t.split("&").map(t=>{const s=t.split("=");e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]||"")}),e}),this.parsePath=((t,e)=>{const s=t.indexOf("?"),i=s>0?t.substr(s+1,t.length):"",r=this.splitPath(t),a=this.splitPath(e);let o={};s>0&&(o={queryString:this.parseQuery(i)});for(let t=0;t<a.length;t++)if(":"===a[t].charAt(0)){const e=a[t].slice(1);if(r.length<=t)return null;o[e]=decodeURIComponent(r[t])}else if(!r[t]||a[t].toLocaleLowerCase()!==r[t].toLocaleLowerCase())return null;return o}),this.stringify=(t=>{const e=[],s=t=>{if("function"==typeof t)return String(t);if(t instanceof Error)return t.message;if(null===t||"object"!=typeof t)return t;if(-1!==e.indexOf(t))return`[Circular: ${e.indexOf(t)}]`;if(e.push(t),Array.isArray(t)){const i=t.map(s);return e.pop(),i}const i=Object.keys(t).reduce((e,i)=>(e[i]=s(((t,e)=>{if(Object.prototype.hasOwnProperty.call(t,e))try{return t[e]}catch(t){return t.message}return t[e]})(t,i)),e),{});return e.pop(),i};return JSON.stringify(s(t))}),this.cloneObject=(t=>{var e=Array.isArray(t);return null===t||"object"!=typeof t?t:Object.keys(t).reduce((e,s)=>null!==t[s]&&"object"==typeof t[s]?(e[s]=this.cloneObject(t[s]),e):(e[s]=t[s],e),e?[]:{})}),this.getStateDiff=(t=>{t.sort((t,e)=>e.length-t.length).map(e=>{if(!this.stateDiff[e]){this.stringify(this.getState(e,this.prevState)||"")!==this.stringify(this.getState(e,this.state)||"")&&(this.stateDiff[e]=!0,t.map(t=>{e!==t&&0===e.indexOf(t)&&(this.stateDiff[t]=!0)}))}})}),this.invokeStateWatchers=this.debounce(()=>{const t=Object.keys(this.stateWatchers),e=Object.keys(this.stateDiff);this.stateDiff={},t.filter(t=>e.includes(t)).sort((t,e)=>e.length-t.length).map(t=>{Object.keys(this.stateWatchers[t]).map(e=>{const s=this.getState(t);this.stateWatchers[t][e]&&this.stateWatchers[t][e].map(t=>t&&t(s))})})},10),this.setState=(t=>{const e=Object.keys(this.stateWatchers);e.length>0&&(this.prevState=this.cloneObject(this.state)),this.mergeState(this.state,t),e.length>0&&(this.getStateDiff(e),this.invokeStateWatchers())}),this.getState=((t,e)=>{const s=t?t.split(".").reduce((t,e)=>t&&t[e]||void 0,e||this.state):e||this.state;return s?Object.freeze(this.cloneObject(s)):void 0}),this.watchState=((t,e,s)=>{e&&s&&(this.stateWatchers[e]||(this.stateWatchers[e]={}),this.stateWatchers[e]=Object.assign(Object.assign({},this.stateWatchers[e]),{[t]:[...this.stateWatchers[e][t]||[],s]}))}),this.unwatchState=((t,e)=>{const s=e=>{this.stateWatchers[e][t]=void 0,delete this.stateWatchers[e][t],0===Object.keys(this.stateWatchers[e]).length&&delete this.stateWatchers[e]};if(e){(Array.isArray(e)?e:[e]).map(t=>{!this.stateWatchers[t]&&(this.stateWatchers[t]={}),s(t)})}else Object.keys(this.stateWatchers).map(s)}),this.reportError=(t=>{if(!this.options.onError)throw t;this.options.onError(t)}),this.openHotWs=(t=>{try{console.log("Connecting HOT...");const e=!0===t?8080:t;this.wsHotClient=null,this.wsHotClient=new WebSocket(`ws://localhost:${e}`),this.wsHotClient.addEventListener("message",t=>{try{const e=JSON.parse(t.data||"");if(e.message)return void console.log(e.message);e.filePath&&this.digestHot(e)}catch(t){console.error("Could not parse HOT message:",t)}}),this.wsHotClient.onclose=(()=>{console.warn("HOT Connection Closed!"),setTimeout(this.openHotWs,5e3,t)})}catch(t){console.error(t)}}),this.digestHot=(t=>{const e=(t,e)=>t&&e&&t.split("?").shift().toLocaleLowerCase()==e.split("?").shift().toLocaleLowerCase();try{const s=t.filePath.replace(/\\/g,"/"),i=this.win[this.pagesNamespace];if(e(this.options.globalCssUrl,s))return console.log(`${t.filePath} updated.`),this.loadedCsss[t.filePath]=t.data,void this.insertCss(t.data,"globalCss");if(this.currentJS&&e(this.options.globalTemplatesUrl,s))return console.log(`${t.filePath} updated.`),this.parseTemplate(t.data,this.options.globalTemplatesUrl),this.initJS(this.currentJS),void this.setNavimiLinks();if(this.currentJS&&this.externalJSsMap[s])return console.log(`${t.filePath} updated.`),i[this.callbackNS+s]=(()=>{Object.keys(this.externalJSsMap[s]).map(t=>{this.routesJSs[t]=void 0,t===this.currentJS&&this.initRoute(void 0,void 0,!0)})}),void this.insertJS(t.data,s,!0);if(this.currentJS&&this.externalTemplatesMap[s])return console.log(`${t.filePath} updated.`),this.parseTemplate(t.data),void(Object.keys(this.externalTemplatesMap[s]).find(t=>t===this.currentJS)&&this.initJS(this.currentJS));for(const r in this.routingList){const a=this.routingList[r];if(this.currentJS&&e(a.jsUrl,s))return void(this.routesJSs[a.jsUrl]&&(console.log(`${t.filePath} updated.`),this.routesJSs[a.jsUrl]=void 0,i[this.callbackNS+a.jsUrl]=(()=>{this.currentJS===a.jsUrl&&this.initJS(this.currentJS)}),this.insertJS(t.data,a.jsUrl,!1),this.setNavimiLinks()));if(e(a.cssUrl,s))return console.log(`${t.filePath} updated.`),this.loadedCsss[a.cssUrl]=t.data,void((this.currentJS&&this.currentJS===a.jsUrl||a.cssUrl===this.currentRouteItem.cssUrl)&&this.insertCss(t.data,"pageCss"));if(e(a.templatesUrl,s))return console.log(`${t.filePath} updated.`),this.parseTemplate(t.data,a.templatesUrl),(this.currentJS&&this.currentJS===a.jsUrl||a.templatesUrl===this.currentRouteItem.templatesUrl)&&this.initJS(this.currentJS),void this.setNavimiLinks()}}catch(t){console.error("Could not digest HOT message: ",t)}}),this.fetchFile=((t,e)=>new Promise((s,i)=>{delete this.loadErrors[t],fetch(t,e).then(async e=>{if(!e||!e.ok){const e=`Could not load the file! - ${t}`;return this.loadErrors[t]=e,i(e)}s(await e.text())}).catch(e=>{this.loadErrors[t]=e.message,i(e)})})),this.parseTemplate=((t,e)=>{const s=new RegExp("<t ([^>]+)>"),i=new RegExp("</t>"),r=new RegExp('id="([^"]+)"');let a=t;if(s.exec(a))for(;t&&t.length>0;){const t=s.exec(a);if(!t||0===t.length)break;const e=r.exec(t[1]),o=e.length>0&&e[1];a=a.substr(t.index+t[0].length);const n=i.exec(a);if(!o||!n||0===n.length)break;this.templatesCache[o]=a.substr(0,n.index)}else this.templatesCache[e]=a}),this.fetchTemplate=((t,e)=>{const s=e=>new Promise(async(s,i)=>{if(!e||this.loadedTemplates[e])return s();try{const r=await this.fetchFile(e,{headers:{Accept:"text/html"},signal:t?this.controller.signal:void 0});this.parseTemplate(r,e),this.loadedTemplates[e]=!0,s()}catch(t){i(t)}});return e.length>1?Promise.all(e.map(s)):s(e[0])}),this.fetchCss=((t,e,s)=>new Promise(async(i,r)=>{if(!t||this.loadedCsss[t])return i();try{const a=await this.fetchFile(t,{headers:{Accept:"text/css"},signal:e?void 0:this.controller.signal});s?(this.insertCss(a,void 0,!0),this.loadedCsss[t]="loaded"):this.loadedCsss[t]=a,i()}catch(t){r(t)}})),this.fetchJS=((t,e)=>new Promise(async(s,i)=>{try{const r=await this.fetchFile(t,{headers:{Accept:"application/javascript"},signal:this.controller.signal});this.loadedJs[t]=!0,this.insertJS(r,t,e),s()}catch(t){i(t)}})),this.addLibrary=(async t=>{let e=Array.isArray(t)?t:[t];(e=e.filter(t=>!this.loadedJs[t])).length>0&&await Promise.all(e.map(t=>{return"css"===t.split(".").pop().toLocaleLowerCase()?this.fetchCss(t,!1,!0):this.fetchJS(t)})).catch(t=>{throw new Error(t)})}),this.insertCss=((t,e,s)=>{const i=e?document.querySelector(`[${e}]`):void 0;if(i&&i.remove(),!t)return;const r=document.createElement("style");r.innerHTML=t,e&&r.setAttribute(e,"");const a=document.getElementsByTagName("head")[0]||document.body;s?a.prepend(r):a.appendChild(r)}),this.insertJS=((t,e,s)=>{const i=document.querySelector(`[jsUrl='${e}']`);i&&i.remove();let r=void 0!==s?`(function(){window.${this.pagesNamespace}.${this.pagesMainCallBack}("${e}", ${s}, (function(){return ${t}   \n    })())}())`:t;const a=document.createElement("script");a.type="text/javascript",a.innerHTML=r,a.setAttribute("jsUrl",e),(document.getElementsByTagName("head")[0]||document.body).appendChild(a)}),this.getTemplate=(t=>{const e=(Array.isArray(t)?t:[t]).map(t=>this.templatesCache[t]);return e.length>1?e:e[0]}),this.executeMiddlewares=(async(t,e)=>{let s=-1;const i=async(r,a,o)=>{if(r===s)throw new Error("next() called multiple times");s=r;const n=this.middlewareStack[r];n?await n(t,(t,s)=>{e===this.callId&&(t?(o(),this.initRoute(t,s,!0)):i(r+1,a,o))}):a()};await new Promise(async(t,e)=>{await i(0,t,e)})}),this.setupRoute=(async t=>{const e=this.win[this.pagesNamespace],s=async(t,s,i)=>{if(setTimeout(()=>{delete e[this.callbackNS+t],delete e[this.callbackNS+t+"_reject"]},1e3),s)return this.externalJSs[t]=i,Object.freeze(i);const a=Object.freeze({addLibrary:this.addLibrary,setTitle:this.setTitle,navigateTo:this.navigateTo,getTemplate:this.getTemplate,fetchJS:e=>{const s=Array.isArray(e)?e:[e];return s.map(e=>{this.externalJSsMap[e]=Object.assign(Object.assign({},this.externalJSsMap[e]||{}),{[t]:!0})}),r(!0,s)},fetchTemplate:e=>{const s=Array.isArray(e)?e:[e];return s.map(e=>{this.externalTemplatesMap[e]=Object.assign(Object.assign({},this.externalTemplatesMap[e]||{}),{[t]:!0})}),this.fetchTemplate(!0,s)},setState:this.setState,getState:this.getState,setNavimiLinks:this.setNavimiLinks,unwatchState:e=>this.unwatchState(t,e),watchState:(e,s)=>this.watchState(t,e,s)});let o;if(this.routesJSsServices[t].length>0){for(;-1!==this.routesJSsServices[t].map(t=>void 0===this.externalJSs[this.options.services[t]]).indexOf(!0);){if(this.routesJSsServices[t].map(t=>this.options.services[t]).find(t=>this.loadErrors[t]))return;await this.timeout(10)}this.routesJSsServices[t].map(t=>{o=Object.assign(Object.assign({},o),{[t]:this.externalJSs[this.options.services[t]]})})}try{this.unwatchState(t);let s=new i(a,o);return this.routesJSs[t]=s,s}catch(s){e[this.callbackNS+t+"_reject"](s)}},i=t=>new Promise((s,i)=>{const r=setInterval(()=>this.routesJSs[t]?(clearInterval(r),s(this.routesJSs[t])):void 0===e[this.callbackNS+t]?(clearInterval(r),i(`Error loading file! ${t}`)):void 0,50)}),r=(t,s)=>{const r=s=>new Promise(async(r,a)=>{if(t){if(this.externalJSs[s])return r(this.externalJSs[s])}else if(this.routesJSs[s])return r(this.routesJSs[s]);e[this.callbackNS+s]?await i(s).then(r).catch(a):(e[this.callbackNS+s]=r,e[this.callbackNS+s+"_reject"]=a,this.fetchJS(s,t).catch(t=>{delete e[this.callbackNS+s],e[this.callbackNS+s+"_reject"](t)}))});return s.length>1?Promise.all(s.map(r)):r(s[0])};e[this.pagesMainCallBack]||(e[this.pagesMainCallBack]=((t,i,r)=>{e[this.callbackNS+t](s(t,i,r))}));const{jsUrl:a,cssUrl:o,templatesUrl:n,dependsOn:h}=t;if(this.fetchCss(o).catch(t=>{}),this.fetchTemplate(!0,[n]).catch(t=>{}),a){if(this.routesJSsServices[a]=this.routesJSsServices[a]||[],h&&h.length>0){let t=[];const e=h.map(e=>{const s=this.options.services&&this.options.services[e];return void 0===s?t.push(e):(-1===this.routesJSsServices[a].indexOf(e)&&this.routesJSsServices[a].push(e),this.externalJSsMap[s]=Object.assign(Object.assign({},this.externalJSsMap[s]||{}),{[a]:!0})),s});if(t.length>0)return void this.reportError(new Error("Service(s) not defined: "+t.join(", ")));Promise.all(e.filter(t=>void 0!==t).map(t=>r(!0,[t]))).catch(this.reportError)}return r(!1,[a])}}),this.initRoute=(async(t,e,s)=>{const i=this.removeHash(t||this.getUrl());if(!s){if(this.currentUrl===i)return;this.controller.abort(),this.controller=new AbortController}const r=++this.callId,a=void 0!==t,o=this.splitPath(i);let n,h;for(const t in this.routingList){if(this.splitPath(t).length===o.length&&(h=this.parsePath(i,t))){n=this.routingList[t];break}}const l=this.routingList["*"];if(!n&&l&&(n=l),void 0!==e&&(h=Object.assign(Object.assign({},h),e)),this.options.onBeforeRoute){if(!1===await this.options.onBeforeRoute({url:i,routeItem:n,params:h},this.navigateTo))return}if(this.currentJS&&!s){const t=this.routesJSs[this.currentJS]&&this.routesJSs[this.currentJS].beforeLeave;if(t&&!1===t({url:i,routeItem:n,params:h}))return void(a||history.forward());this.routesJSs[this.currentJS]&&this.routesJSs[this.currentJS].destroy&&this.routesJSs[this.currentJS].destroy()}if(n){try{await this.executeMiddlewares({url:i,routeItem:n,params:h},r)}catch(t){return}if(!(r<this.callId)){this.currentRouteItem=n,this.currentUrl=i;try{const{title:s,jsUrl:o,cssUrl:l,templatesUrl:c}=n||{};if(!o&&!c)throw new Error("The route must define the 'jsUrl' or 'templatesUrl'!");for(o&&(this.currentJS=o,this.currentParams[o]={url:i,routeItem:n,params:h}),a&&((null==e?void 0:e.replaceUrl)?history.replaceState(null,null,t):history.pushState(null,null,t)),await this.setupRoute(n);l&&!this.loadedCsss[l]||c&&!this.loadedTemplates[c]||this.options.globalCssUrl&&!this.loadedCsss[this.options.globalCssUrl]||this.options.globalTemplatesUrl&&!this.loadedTemplates[this.options.globalTemplatesUrl];){if(await this.timeout(10),r<this.callId)return;if(l&&this.loadErrors[l]||c&&this.loadErrors[c]||this.options.globalCssUrl&&this.loadErrors[this.options.globalCssUrl]||this.options.globalTemplatesUrl&&this.loadErrors[this.options.globalTemplatesUrl])return void this.reportError(new Error(this.loadErrors[l]||this.loadErrors[c]||this.loadErrors[this.options.globalCssUrl]||this.loadErrors[this.options.globalTemplatesUrl]))}this.setTitle(s);try{await this.initJS(o)}catch(t){this.reportError(t)}finally{if(r<this.callId)return;this.setNavimiLinks(),this.insertCss(this.loadedCsss[l],"pageCss"),this.options.onAfterRoute&&this.options.onAfterRoute({url:i,routeItem:n,params:h},this.navigateTo)}}catch(t){r===this.callId&&this.reportError(t)}}}else r===this.callId&&this.reportError(new Error("No route match for url: "+i))}),this.initJS=(async t=>{if(t)this.routesJSs[t]&&this.routesJSs[t].init&&await this.routesJSs[t].init(this.currentParams[t]);else{const t=this.currentRouteItem?this.currentRouteItem.templatesUrl:null,e=this.getTemplate(t),s=document.querySelector("body");e&&s&&(s.innerHTML=e)}}),this.pagesNamespace="__spaPages",this.pagesMainCallBack="_mainCallback",this.callbackNS="_callback_",this.win=window||{},this.controller=new AbortController,this.currentRouteItem=void 0,this.currentJS=void 0,this.currentUrl=void 0,this.currentParams={},this.routesJSs={},this.routesJSsServices={},this.externalJSs={},this.externalJSsMap={},this.externalTemplatesMap={},this.routingList=t||{},this.loadErrors={},this.loadedCsss={},this.loadedJs={},this.loadedTemplates={},this.templatesCache={},this.options=e||{},this.state={},this.prevState={},this.stateDiff={},this.stateWatchers={},this.middlewareStack=[],this.callId=0,this.win.addEventListener("popstate",()=>{this.initRoute()}),this.win.navigateTo=this.navigateTo,this.win[this.pagesNamespace]={};const s=this.options.middlewares;Array.isArray(s)&&this.middlewareStack.push(...s.filter(t=>void 0!==t)),(async()=>{(this.options.globalCssUrl||this.options.globalTemplatesUrl)&&(await Promise.all([this.fetchCss(this.options.globalCssUrl,!0),this.fetchTemplate(!1,[this.options.globalTemplatesUrl])]).catch(this.reportError),this.insertCss(this.loadedCsss[this.options.globalCssUrl],"globalCss"))})(),this.initRoute(),this.options.hot&&"WebSocket"in this.win&&setTimeout(this.openHotWs,1e3,this.options.hot)}mergeState(t,e){e instanceof Error&&(e=Object.assign(Object.assign({},e),{message:e.message,stack:e.stack}));const s=t=>t&&"object"==typeof t&&!Array.isArray(t)&&null!==t;if(s(t)&&s(e))for(const i in e)s(e[i])?(!t[i]&&Object.assign(t,{[i]:{}}),this.mergeState(t[i],e[i])):Object.assign(t,{[i]:e[i]})}}class NavimiRoute{constructor(t,e){}init(t){}beforeLeave(t){}destroy(){}}